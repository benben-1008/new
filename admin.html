<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OliMeal - ç®¡ç†ã‚µã‚¤ãƒˆ</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* èƒŒæ™¯ç”»åƒè¨­å®šï¼ˆoliveï¼‰ */
    .page-bg {
      background-image: url('images/olive.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    /* å¯èª­æ€§å‘ä¸Šã®ãŸã‚ã®åŠé€æ˜èƒŒæ™¯ */
    .container {
      background-color: rgba(255, 255, 255, 0.92);
    }

    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ã®ç°¡å˜ãªãƒ‡ã‚¶ã‚¤ãƒ³ */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      text-align: center;
      margin-top: 10px;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
    }

    .calendar div {
      padding: 5px;
    }

    .holiday {
      background-color: #ffcccc;
      border-radius: 6px;
    }

    /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .tab-navigation {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
    }

    .tab-button {
      padding: 12px 24px;
      background-color: #f8f9fa;
      border: 2px solid #ddd;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
      border-bottom: none;
    }

    .tab-button:hover {
      background-color: #e9ecef;
    }

    .tab-button.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
    .accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 10px;
      transition: all 0.3s;
    }

    .accordion-header:hover {
      background-color: #e9ecef;
    }

    .accordion-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .accordion-icon {
      font-size: 20px;
      transition: transform 0.3s;
    }

    .accordion-header.active .accordion-icon {
      transform: rotate(180deg);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .accordion-content.active {
      max-height: 5000px;
      transition: max-height 0.5s ease-in;
    }

    .accordion-body {
      padding: 20px;
      background-color: white;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 8px 8px;
      margin-bottom: 10px;
    }

    /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body class="page-bg">
  <div class="container">
    <header>
      <h1>ğŸ”§ OliMeal</h1>
      <p>ç®¡ç†ç”¨ã‚µã‚¤ãƒˆ</p>
    </header>

    <main>
      <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div class="tab-navigation">
        <button class="tab-button active" onclick="switchTab('basic', this)">âš™ï¸ åŸºæœ¬è¨­å®š</button>
        <button class="tab-button" onclick="switchTab('data', this)">ğŸ“ äºˆç´„ç¢ºèª</button>
        <button class="tab-button" onclick="switchTab('shifts', this)">ğŸ“… ã‚·ãƒ•ãƒˆè¡¨</button>
        <button class="tab-button" onclick="switchTab('ai-advice', this)">ğŸ¤– AIã‚¢ãƒ‰ãƒã‚¤ã‚¹</button>
        <button class="tab-button" onclick="switchTab('system', this)">ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†</button>
        <button class="tab-button" onclick="switchTab('other', this)">ğŸ”— URL</button>
      </div>

      <!-- åŸºæœ¬è¨­å®šã‚¿ãƒ– -->
      <div id="tab-basic" class="tab-content active">
        <!-- ğŸ”¹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç† -->
        <section class="admin-section">
          <div class="accordion-header active" onclick="toggleAccordion(this)">
            <h3>ğŸ± ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</h3>
            <span class="accordion-icon">â–¼</span>
          </div>
          <div class="accordion-content active">
            <div class="accordion-body">
              <div class="grid-2">
                <div class="admin-card">
                  <h3>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ </h3>
                  <div class="form-group">
                    <label for="menu-name">ãƒ¡ãƒ‹ãƒ¥ãƒ¼å:</label>
                    <input type="text" id="menu-name" placeholder="ä¾‹: ã‚«ãƒ¬ãƒ¼" required>
                  </div>
                  <div class="form-group">
                    <label for="menu-stock">æä¾›å¯èƒ½æ•°:</label>
                    <input type="number" id="menu-stock" placeholder="ä¾‹: 30">
                  </div>
                  <div class="form-group">
                    <label
                      style="display: flex; align-items: center; font-weight: bold; color: #e74c3c; font-size: 16px; padding: 12px; background-color: #fff5f5; border: 2px solid #e74c3c; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                      <input type="checkbox" id="unlimited-stock" onchange="toggleStockInput()"
                        style="margin-right: 12px; transform: scale(2.0); cursor: pointer;">
                      â™¾ï¸ ç„¡åˆ¶é™ã§æä¾›ï¼ˆåœ¨åº«ç®¡ç†ãªã—ï¼‰
                    </label>
                  </div>
                  <button onclick="addMenu()" class="btn btn-primary">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ </button>
                </div>

                <div class="admin-card">
                  <h3>ç¾åœ¨ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§</h3>
                  <div id="menu-list"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ğŸ”¹ ä¼‘æ¥­æ—¥è¨­å®š -->
        <section class="admin-section">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <h3>ğŸ“… ä¼‘æ¥­æ—¥è¨­å®š</h3>
            <span class="accordion-icon">â–¼</span>
          </div>
          <div class="accordion-content">
            <div class="accordion-body">
              <div class="grid-2">
                <div class="admin-card">
                  <h3>ä¼‘æ¥­æ—¥ã‚’è¿½åŠ </h3>
                  <div class="form-group">
                    <label for="holiday-date">æ—¥ä»˜:</label>
                    <input type="date" id="holiday-date" required>
                  </div>
                  <div class="form-group">
                    <label for="holiday-reason">ç†ç”±ï¼ˆä»»æ„ï¼‰:</label>
                    <input type="text" id="holiday-reason" placeholder="ä¾‹: è¨­å‚™ç‚¹æ¤œï¼ˆç©ºç™½ã§ã‚‚å¯ï¼‰">
                  </div>
                  <button onclick="addHoliday()" class="btn btn-primary">ä¼‘æ¥­æ—¥ã‚’è¿½åŠ </button>
                  <button onclick="addWeekendHolidays()" class="btn btn-secondary">ä»Šæœˆã®åœŸæ—¥ã‚’è‡ªå‹•è¿½åŠ </button>
                </div>

                <div class="admin-card">
                  <h3>ğŸ—“ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º</h3>
                  <div id="calendar" class="calendar"></div>
                </div>
              </div>
              <div class="admin-card">
                <h3>ç¾åœ¨ã®ä¼‘æ¥­æ—¥ä¸€è¦§</h3>
                <div id="holidays-list" class="holidays-list"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- ğŸ”¹ å®šé£Ÿè¨­å®š -->
        <section class="admin-section">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <h3>ğŸ½ï¸ å®šé£Ÿè¨­å®š</h3>
            <span class="accordion-icon">â–¼</span>
          </div>
          <div class="accordion-content">
            <div class="accordion-body">
              <div class="grid-2">
                <div class="admin-card">
                  <h3>æ—¥åˆ¥å®šé£Ÿã‚’è¨­å®š</h3>
                  <div class="form-group">
                    <label for="daily-menu-date">æ—¥ä»˜:</label>
                    <input type="date" id="daily-menu-date" required>
                  </div>
                  <div class="form-group">
                    <label for="daily-menu-food">å®šé£Ÿãƒ¡ãƒ‹ãƒ¥ãƒ¼:</label>
                    <input type="text" id="daily-menu-food" placeholder="ä¾‹: ã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹ã€æ—¥æ›¿ã‚ã‚Šå®šé£Ÿ" required>
                  </div>
                  <button onclick="addDailyMenu()" class="btn btn-primary">å®šé£Ÿã‚’è¨­å®š</button>
                </div>

                <div class="admin-card">
                  <h3>ç¾åœ¨ã®å®šé£Ÿè¨­å®šä¸€è¦§</h3>
                  <div id="daily-menu-list"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ğŸ”¹ è¡Œäº‹ãƒ»ãŠçŸ¥ã‚‰ã›è¨­å®š -->
        <section class="admin-section">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <h3>ğŸ“¢ è¡Œäº‹ãƒ»ãŠçŸ¥ã‚‰ã›è¨­å®š</h3>
            <span class="accordion-icon">â–¼</span>
          </div>
          <div class="accordion-content">
            <div class="accordion-body">
              <div class="grid-2">
                <div class="admin-card">
                  <h3>è¡Œäº‹ãƒ»ãŠçŸ¥ã‚‰ã›ã‚’è¿½åŠ </h3>
                  <div class="form-group">
                    <label for="event-date">æ—¥ä»˜:</label>
                    <input type="date" id="event-date" required>
                  </div>
                  <div class="form-group">
                    <label for="event-message">å†…å®¹:</label>
                    <input type="text" id="event-message" placeholder="ä¾‹: æ–‡åŒ–ç¥­ã€ç‰¹åˆ¥ãƒ¡ãƒ‹ãƒ¥ãƒ¼æä¾›æ—¥" required>
                  </div>
                  <button onclick="addEvent()" class="btn btn-primary">è¡Œäº‹ãƒ»ãŠçŸ¥ã‚‰ã›ã‚’è¿½åŠ </button>
                </div>

                <div class="admin-card">
                  <h3>ç¾åœ¨ã®è¡Œäº‹ãƒ»ãŠçŸ¥ã‚‰ã›ä¸€è¦§</h3>
                  <div id="events-list"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ğŸ”¹ äºˆç´„æ™‚é–“è¨­å®š -->
        <section class="admin-section">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <h3>â° äºˆç´„æ™‚é–“è¨­å®š</h3>
            <span class="accordion-icon">â–¼</span>
          </div>
          <div class="accordion-content">
            <div class="accordion-body">
              <div class="grid-2">
                <div class="admin-card">
                  <h3>äºˆç´„å¯èƒ½æ™‚é–“ã‚’è¨­å®š</h3>
                  <div id="time-slots-container">
                    <!-- æ™‚é–“å¸¯ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                  </div>
                  <button onclick="addTimeSlot()" class="btn btn-secondary" style="margin-top: 10px;">+ æ™‚é–“å¸¯ã‚’è¿½åŠ </button>
                  <div class="form-group" style="margin-top: 15px;">
                    <label for="reservation-message">è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</label>
                    <input type="text" id="reservation-message" placeholder="ä¾‹: äºˆç´„æ™‚é–“: 11:30-12:45, 17:00-18:30">
                  </div>
                  <p style="color: #666; font-size: 14px; margin-top: -10px; margin-bottom: 10px;">
                    â€» äºˆç´„æ™‚é–“ã‚’è¨­å®šã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«æœ‰åŠ¹ã«ãªã‚Šã¾ã™
                  </p>
                  <button onclick="updateReservationTimes()" class="btn btn-primary">äºˆç´„æ™‚é–“ã‚’æ›´æ–°</button>
                </div>

                <div class="admin-card">
                  <h3>ç¾åœ¨ã®äºˆç´„æ™‚é–“è¨­å®š</h3>
                  <div id="reservation-times-display"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>

      <!-- ã‚·ãƒ•ãƒˆè¡¨ã‚¿ãƒ– -->
      <div id="tab-shifts" class="tab-content">
        <section class="admin-section">
          <div class="accordion-header active" onclick="toggleAccordion(this)">
            <h3>ğŸ“… ã‚·ãƒ•ãƒˆè¡¨ç®¡ç†</h3>
            <span class="accordion-icon">â–¼</span>
          </div>
          <div class="accordion-content active">
            <div class="accordion-body">
              <div class="admin-card">
                <h3>ã‚·ãƒ•ãƒˆè¡¨</h3>
                <div class="form-group">
                  <label for="shift-display-month">è¡¨ç¤ºæœˆ:</label>
                  <input type="month" id="shift-display-month" onchange="loadShifts()">
                </div>
                <div class="form-group">
                  <label for="shift-employee-name">å¾“æ¥­å“¡åã‚’è¿½åŠ :</label>
                  <div style="display: flex; gap: 10px;">
                    <input type="text" id="shift-employee-name" placeholder="ä¾‹: ç”°ä¸­å¤ªéƒ" style="flex: 1;">
                    <button onclick="addEmployeeName()" class="btn btn-secondary">è¿½åŠ </button>
                  </div>
                </div>
                <p style="color: #666; font-size: 14px; margin-top: 10px;">
                  ğŸ’¡ ã‚·ãƒ•ãƒˆè¡¨ã®ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è¨˜å·ã‚’é¸æŠã§ãã¾ã™ï¼ˆã€‡=å‡ºå‹¤ã€X=ä¼‘ã¿ã€å—=å—ä»˜ã€H=æ®‹æ¥­ã€æ•°å­—=ãã®ä»–ï¼‰
                </p>
                <div id="shifts-list"></div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚¿ãƒ– -->
      <div id="tab-data" class="tab-content">
        <!-- ğŸ”¹ äºˆç´„ä¸€è¦§ -->
        <section class="admin-section">
          <div class="accordion-header active" onclick="toggleAccordion(this)">
            <h3>ğŸ“ äºˆç´„ä¸€è¦§</h3>
            <span class="accordion-icon">â–¼</span>
          </div>
          <div class="accordion-content active">
            <div class="accordion-body">
              <div class="admin-card">
                <h3>äºˆç´„çŠ¶æ³</h3>
                <div style="margin-bottom:10px;">
                  <button onclick="loadReservations()" class="btn btn-primary">äºˆç´„ä¸€è¦§ã‚’æ›´æ–°</button>
                  <a href="reservation-list.html" class="btn btn-secondary" style="text-decoration:none;">ç®¡ç†ç”¨ï¼šäºˆç´„ä¸€è¦§ï¼ˆèªè¨¼ï¼‰ã‚’é–‹ã</a>
                </div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-bottom:10px;">
                  <div class="form-group" style="margin:0;min-width:200px;flex:0 0 auto;">
                    <label for="admin-filter-date">è¡¨ç¤ºæ—¥</label>
                    <input type="date" id="admin-filter-date">
                  </div>
                  <div class="form-group" style="margin:0;min-width:200px;flex:0 0 auto;">
                    <label for="admin-filter-mode">è¡¨ç¤º</label>
                    <select id="admin-filter-mode" style="width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;">
                      <option value="all" selected>ã™ã¹ã¦</option>
                      <option value="today">æŒ‡å®šæ—¥ã®äºˆç´„ã®ã¿</option>
                      <option value="unverified">æœªèªè¨¼ã®ã¿</option>
                      <option value="verified">èªè¨¼æ¸ˆã¿ã®ã¿</option>
                    </select>
                  </div>
                  <div class="form-group" style="margin:0;min-width:260px;flex:1 1 260px;">
                    <label for="admin-filter-q">æ¤œç´¢ï¼ˆåå‰/ã‚¯ãƒ©ã‚¹/ç•ªå·/ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰</label>
                    <input type="text" id="admin-filter-q" placeholder="ä¾‹: ç”°ä¸­ / 2A / 123 / ã‚«ãƒ¬ãƒ¼">
                  </div>
                </div>
                <div id="reservations-list"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- ğŸ”¹ ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ -->
        <section class="admin-section">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <h3>â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§</h3>
            <span class="accordion-icon">â–¼</span>
          </div>
          <div class="accordion-content">
            <div class="accordion-body">
              <div class="admin-card">
                <h3>æŠ•ç¨¿ã•ã‚ŒãŸãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div style="margin-bottom:10px;">
                  <button onclick="loadReviews()" class="btn btn-primary">ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ã‚’æ›´æ–°</button>
                </div>
                <div id="reviews-list"></div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ã‚¿ãƒ– -->
      <div id="tab-system" class="tab-content">
        <!-- ğŸ”¹ æœˆé–“ãƒ¬ãƒãƒ¼ãƒˆ -->
        <section class="admin-section">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <h3>ğŸ“Š æœˆé–“ãƒ¬ãƒãƒ¼ãƒˆ</h3>
            <span class="accordion-icon">â–¼</span>
          </div>
          <div class="accordion-content">
            <div class="accordion-body">
              <div class="admin-card">
                <h3>ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</h3>
                <div class="form-group">
                  <label for="report-year">å¹´:</label>
                  <select id="report-year">
                    <option value="2024">2024å¹´</option>
                    <option value="2025" selected>2025å¹´</option>
                    <option value="2026">2026å¹´</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="report-month">æœˆ:</label>
                  <select id="report-month">
                    <option value="1">1æœˆ</option>
                    <option value="2">2æœˆ</option>
                    <option value="3">3æœˆ</option>
                    <option value="4">4æœˆ</option>
                    <option value="5">5æœˆ</option>
                    <option value="6">6æœˆ</option>
                    <option value="7">7æœˆ</option>
                    <option value="8">8æœˆ</option>
                    <option value="9">9æœˆ</option>
                    <option value="10">10æœˆ</option>
                    <option value="11">11æœˆ</option>
                    <option value="12">12æœˆ</option>
                  </select>
                </div>
                <div style="margin-bottom:10px;">
                  <button onclick="generateReport()" class="btn btn-primary">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
                  <button onclick="downloadReport()" class="btn btn-success">Excelå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                </div>
                <div id="report-display"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- ğŸ”¹ AIåˆ†æ -->
        <section class="admin-section">
          <div class="accordion-header" onclick="toggleAccordion(this)">
            <h3>ğŸ¤– AIåˆ†æ</h3>
            <span class="accordion-icon">â–¼</span>
          </div>
          <div class="accordion-content">
            <div class="accordion-body">
              <div class="admin-card">
                <h3>AIã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åˆ†æ</h3>
                <p style="color: #666; margin-bottom: 15px;">
                  ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚„å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’AIãŒåˆ†æã—ã€æ”¹å–„ç‚¹ã‚„è‰¯ã„ç‚¹ã‚’ã‚ã‹ã‚Šã‚„ã™ãæç¤ºã—ã¾ã™ã€‚
                </p>
                <div class="form-group">
                  <label for="ai-analysis-year">å¹´:</label>
                  <select id="ai-analysis-year">
                    <option value="2024">2024å¹´</option>
                    <option value="2025" selected>2025å¹´</option>
                    <option value="2026">2026å¹´</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="ai-analysis-month">æœˆ:</label>
                  <select id="ai-analysis-month">
                    <option value="1">1æœˆ</option>
                    <option value="2">2æœˆ</option>
                    <option value="3">3æœˆ</option>
                    <option value="4">4æœˆ</option>
                    <option value="5">5æœˆ</option>
                    <option value="6">6æœˆ</option>
                    <option value="7">7æœˆ</option>
                    <option value="8">8æœˆ</option>
                    <option value="9">9æœˆ</option>
                    <option value="10">10æœˆ</option>
                    <option value="11">11æœˆ</option>
                    <option value="12">12æœˆ</option>
                  </select>
                </div>
                <div style="margin-bottom:10px;">
                  <button onclick="performAIAnalysis()" class="btn btn-primary">ğŸ¤– AIåˆ†æã‚’å®Ÿè¡Œ</button>
                </div>
                <div id="ai-analysis-display"></div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚¿ãƒ– -->
      <div id="tab-ai-advice" class="tab-content">
        <section class="admin-section">
          <div class="accordion-header active" onclick="toggleAccordion(this)">
            <h3>ğŸ¤– AIã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
            <span class="accordion-icon">â–¼</span>
          </div>
          <div class="accordion-content active">
            <div class="accordion-body">
              <div class="grid-2">
                <div class="admin-card">
                  <h3>ğŸ“Š æ¥å®¢æ•°ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                  <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    â€» ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.xlsxï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€æ¥å®¢æ•°äºˆæ¸¬ã®ç²¾åº¦ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚<br>
                    â€» ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®1åˆ—ç›®ã«æ—¥ä»˜ã€2åˆ—ç›®ã«æ¥å®¢æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                  </p>
                  <div class="form-group">
                    <label for="excel-file">ã‚¨ã‚¯ã‚»ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                    <input type="file" id="excel-file" accept=".xlsx,.xls,.csv" style="margin-top: 5px;">
                  </div>
                  <button onclick="uploadExcelFile()" class="btn btn-primary">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                  <div id="excel-upload-status" style="margin-top: 10px;"></div>
                </div>

                <div class="admin-card">
                  <h3>ğŸ“ˆ ç¾åœ¨ã®æ¥å®¢æ•°ãƒ‡ãƒ¼ã‚¿</h3>
                  <div id="attendance-data-display"></div>
                </div>
              </div>

              <div class="admin-card" style="margin-top: 20px;">
                <h3>ğŸ½ï¸ ä»Šæ—¥ã®ãŠã™ã™ã‚å®šé£Ÿ</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                  AIãŒä»Šæ—¥ã®æ›œæ—¥ã¨äºˆç®—ï¼ˆ400å††ç¨‹åº¦ï¼‰ã«åŸºã¥ã„ã¦ã€ãŠã™ã™ã‚ã®å®šé£Ÿãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ææ¡ˆã—ã¾ã™ã€‚<br>
                  <small style="color: #999;">â€» 1æ—¥1å›ã®ææ¡ˆã§ã™ã€‚åŒã˜æ—¥ã¯åŒã˜ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</small>
                </p>
                <button onclick="getMenuAdvice()" class="btn btn-primary">å®šé£Ÿãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ææ¡ˆ</button>
                <div id="menu-advice-display"
                  style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; min-height: 100px;">
                  <p style="color: #6c757d;">ã€Œå®šé£Ÿãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ææ¡ˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                </div>
                <div id="menu-advice-chat" style="margin-top: 20px; display: none;">
                  <h4 style="margin-bottom: 10px; color: #495057;">ğŸ’¬ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã¤ã„ã¦è³ªå•ã™ã‚‹</h4>
                  <div id="menu-chat-messages"
                    style="max-height: 300px; overflow-y: auto; padding: 10px; background-color: white; border-radius: 8px; border: 1px solid #e9ecef; margin-bottom: 10px;">
                  </div>
                  <div style="display: flex; gap: 10px;">
                    <input type="text" id="menu-chat-input" placeholder="ä¾‹ï¼šã‚‚ã£ã¨è©³ã—ãæ•™ãˆã¦ã€ææ–™ã¯ï¼Ÿãªã©..."
                      style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <button onclick="sendMenuChatMessage()" class="btn btn-primary">é€ä¿¡</button>
                  </div>
                </div>
              </div>

              <div class="admin-card" style="margin-top: 20px;">
                <h3>ğŸ‘¥ ä»Šæ—¥ã®æ¥å®¢æ•°äºˆæ¸¬</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                  AIãŒéå»ã®æ¥å®¢æ•°ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€ä»Šæ—¥ã®æ¥å®¢æ•°ã‚’äºˆæ¸¬ã—ã¾ã™ã€‚
                </p>
                <button onclick="getAttendancePrediction()" class="btn btn-primary">æ¥å®¢æ•°ã‚’äºˆæ¸¬</button>
                <div id="attendance-prediction-display"
                  style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; min-height: 100px;">
                  <p style="color: #6c757d;">ã€Œæ¥å®¢æ•°ã‚’äºˆæ¸¬ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- ãã®ä»–ã‚¿ãƒ– -->
      <div id="tab-other" class="tab-content">
        <section class="admin-section">
          <div class="accordion-header active" onclick="toggleAccordion(this)">
            <h3>ğŸ”— URLãƒªãƒ³ã‚¯</h3>
            <span class="accordion-icon">â–¼</span>
          </div>
          <div class="accordion-content active">
            <div class="accordion-body">
              <div id="page-links" class="admin-card"></div>
            </div>
          </div>
        </section>
      </div>

    </main>

    <footer>
      <p>&copy; 2025 å­¦æ ¡é£Ÿå ‚ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
    </footer>
  </div>

  <script>
    // === API ãƒ˜ãƒ«ãƒ‘ãƒ¼ ===
    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã® api/ ã‚’å‚ç…§ï¼ˆã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã§é–‹ã„ã¦ã‚‚æ­£ã—ãå‹•ä½œï¼‰
    function getApiBase() {
      if (window.location.protocol === 'file:') return 'api/';
      const path = window.location.pathname;
      const lastSlash = path.lastIndexOf('/');
      const basePath = lastSlash >= 0 ? path.substring(0, lastSlash + 1) : '/';
      return basePath + 'api/';
    }
    const API_BASE = 'api/';
    function getApiBaseCandidates() {
      if (typeof window === 'undefined' || !window.location) return ['api/'];
      if (window.location.protocol === 'file:') return ['api/'];
      const sameDir = new URL('api/', window.location.href).toString();
      const parentDir = new URL('../api/', window.location.href).toString();
      const rootDir = window.location.origin + '/api/';
      const candidates = [sameDir, parentDir, rootDir].filter(u => {
        try { return new URL(u).origin === window.location.origin; } catch (_) { return false; }
      });
      return [...new Set(candidates)];
    }

    async function apiGet(path) {
      const candidates = getApiBaseCandidates();
      let lastErr = null;
      for (const base of candidates) {
        try {
          const res = await fetch(base + path, { cache: 'no-store' });
          if (!res.ok) { lastErr = new Error(`GET failed: ${base}${path} (HTTP ${res.status})`); continue; }
          const text = await res.text();
          try {
            return JSON.parse(text);
          } catch (e) {
            lastErr = new Error(`APIå¿œç­”ãŒJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“: ${base}${path}`);
            continue;
          }
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error('GET failed');
    }

    async function apiPost(path, data) {
      const candidates = getApiBaseCandidates();
      let lastErr = null;
      for (const base of candidates) {
        try {
          const res = await fetch(base + path, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (!res.ok) { lastErr = new Error(`POST failed: ${base}${path} (HTTP ${res.status})`); continue; }
          return await res.json();
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error('POST failed');
    }
    // === ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç† ===
    function toggleStockInput() {
      const stockInput = document.getElementById("menu-stock");
      const unlimitedCheckbox = document.getElementById("unlimited-stock");

      if (unlimitedCheckbox.checked) {
        stockInput.disabled = true;
        stockInput.value = "";
        stockInput.placeholder = "ç„¡åˆ¶é™";
      } else {
        stockInput.disabled = false;
        stockInput.placeholder = "ä¾‹: 30";
      }
    }

    async function loadMenus() {
      const list = document.getElementById("menu-list");
      list.innerHTML = "";
      let menus = await apiGet('menu.php');

      // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåœ¨åº«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è£œå®Œï¼ˆåˆå›ã®ã¿ï¼‰
      let needsSave = false;
      menus.forEach(m => {
        if (typeof m.initialStock !== 'number' || m.initialStock <= 0) {
          m.initialStock = m.stock;
          needsSave = true;
        }
      });
      if (needsSave) {
        await apiPost('menu.php', menus);
      }

      if (!menus || menus.length === 0) {
        list.innerHTML = "<p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>";
        return;
      }

      menus.forEach((m, i) => {
        const div = document.createElement("div");
        div.className = "menu-item";
        const stockDisplay = m.stock === -1 ? "ç„¡åˆ¶é™" : `${m.stock}é£Ÿ`;
        div.innerHTML = `
          <p>ğŸ± ${m.name}ã€€æ®‹ã‚Š: ${stockDisplay}</p>
          <div style="display: flex; gap: 5px;">
            <button onclick="editMenuStock(${i})" class="btn btn-secondary">æ®‹æ•°å¤‰æ›´</button>
            <button onclick="deleteMenu(${i})" class="btn btn-danger">å‰Šé™¤</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    async function addMenu() {
      const name = document.getElementById("menu-name").value.trim();
      const unlimitedCheckbox = document.getElementById("unlimited-stock");
      const stockInput = document.getElementById("menu-stock");

      if (!name) return alert("ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

      let stock, initialStock;
      if (unlimitedCheckbox.checked) {
        stock = -1; // ç„¡åˆ¶é™ã‚’-1ã§è¡¨ç¾
        initialStock = -1;
      } else {
        stock = parseInt(stockInput.value);
        if (!stock || stock <= 0) return alert("æä¾›æ•°ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        initialStock = stock;
      }

      const menus = await apiGet('menu.php');
      menus.push({ name, stock, initialStock });
      await apiPost('menu.php', menus);

      document.getElementById("menu-name").value = "";
      document.getElementById("menu-stock").value = "";
      document.getElementById("unlimited-stock").checked = false;
      stockInput.disabled = false;
      stockInput.placeholder = "ä¾‹: 30";
      loadMenus();
    }

    async function editMenuStock(index) {
      const menus = await apiGet('menu.php');
      const menu = menus[index];

      const newStock = prompt(`${menu.name}ã®æ®‹æ•°ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ï¼ˆç¾åœ¨: ${menu.stock === -1 ? 'ç„¡åˆ¶é™' : menu.stock}ï¼‰`, menu.stock === -1 ? '' : menu.stock);

      if (newStock === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«

      if (newStock === '' || newStock === 'ç„¡åˆ¶é™') {
        menu.stock = -1;
      } else {
        const stock = parseInt(newStock);
        if (isNaN(stock) || stock < 0) {
          alert('æœ‰åŠ¹ãªæ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        menu.stock = stock;
      }

      await apiPost('menu.php', menus);
      loadMenus();
    }

    async function deleteMenu(index) {
      const menus = await apiGet('menu.php');
      menus.splice(index, 1);
      await apiPost('menu.php', menus);
      loadMenus();
    }

    // === ä¼‘æ¥­æ—¥ç®¡ç† ===
    async function addHoliday() {
      const date = document.getElementById("holiday-date").value;
      const reason = document.getElementById("holiday-reason").value.trim();
      if (!date) return alert("æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

      const holidays = await apiGet('holidays.php');

      // æ—¢ã«åŒã˜æ—¥ä»˜ã®ä¼‘æ¥­æ—¥ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const existingIndex = holidays.findIndex(h => h.date === date);
      if (existingIndex >= 0) {
        if (!confirm('ã“ã®æ—¥ä»˜ã¯æ—¢ã«ä¼‘æ¥­æ—¥ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) {
          return;
        }
        holidays[existingIndex].reason = reason || 'ä¼‘æ¥­æ—¥';
      } else {
        holidays.push({ date, reason: reason || 'ä¼‘æ¥­æ—¥' });
      }

      await apiPost('holidays.php', holidays);

      document.getElementById("holiday-date").value = "";
      document.getElementById("holiday-reason").value = "";
      loadHolidays();
      renderCalendar();
    }

    // ä»Šæœˆã®åœŸæ—¥ã‚’è‡ªå‹•è¿½åŠ 
    async function addWeekendHolidays() {
      if (!confirm('ä»Šæœˆã®åœŸæ›œæ—¥ã¨æ—¥æ›œæ—¥ã‚’ä¼‘æ¥­æ—¥ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\næ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹æ—¥ä»˜ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      const holidays = await apiGet('holidays.php');
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();

      // ä»Šæœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥ã‚’å–å¾—
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      // ä»Šæœˆã®ã™ã¹ã¦ã®æ—¥ä»˜ã‚’ãƒã‚§ãƒƒã‚¯
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const date = new Date(year, month, day);
        const dayOfWeek = date.getDay(); // 0=æ—¥æ›œæ—¥, 6=åœŸæ›œæ—¥
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        // åœŸæ›œæ—¥ï¼ˆ6ï¼‰ã¾ãŸã¯æ—¥æ›œæ—¥ï¼ˆ0ï¼‰ã®å ´åˆ
        if (dayOfWeek === 0 || dayOfWeek === 6) {
          const reason = dayOfWeek === 0 ? 'æ—¥æ›œæ—¥' : 'åœŸæ›œæ—¥';

          // æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const existingIndex = holidays.findIndex(h => h.date === dateStr);
          if (existingIndex >= 0) {
            holidays[existingIndex].reason = reason;
          } else {
            holidays.push({ date: dateStr, reason: reason });
          }
        }
      }

      await apiPost('holidays.php', holidays);
      alert('ä»Šæœˆã®åœŸæ—¥ã‚’ä¼‘æ¥­æ—¥ã¨ã—ã¦è¿½åŠ ã—ã¾ã—ãŸã€‚');
      loadHolidays();
      renderCalendar();
    }

    async function loadHolidays() {
      const holidays = await apiGet('holidays.php');
      const list = document.getElementById("holidays-list");

      if (!holidays || holidays.length === 0) {
        list.innerHTML = "<p>ä¼‘æ¥­æ—¥ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>";
        return;
      }

      // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
      const sortedHolidays = holidays.sort((a, b) => a.date.localeCompare(b.date));

      list.innerHTML = sortedHolidays.map((h, i) => {
        const div = document.createElement("div");
        div.className = "menu-item";
        const reason = h.reason || 'ä¼‘æ¥­æ—¥';
        div.innerHTML = `
          <p>ğŸ“… ${h.date}ã€€ğŸ“ ${reason}</p>
          <button onclick="deleteHoliday(${i})" class="btn btn-danger">å‰Šé™¤</button>
        `;
        return div.outerHTML;
      }).join('');
    }

    async function deleteHoliday(index) {
      if (!confirm('ã“ã®ä¼‘æ¥­æ—¥ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      const holidays = await apiGet('holidays.php');
      holidays.splice(index, 1);
      await apiPost('holidays.php', holidays);

      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»ã—ã¦ã‹ã‚‰ä¼‘æ¥­æ—¥ä¸€è¦§ã‚’æ›´æ–°
      await renderCalendar();
      loadHolidays();
    }

    // === ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º ===
    async function renderCalendar() {
      const calendar = document.getElementById("calendar");
      const holidays = await apiGet('holidays.php');
      const dailyMenus = await apiGet('daily-menu.php');
      const events = await apiGet('events.php');
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth(); // 0å§‹ã¾ã‚Š

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startWeekday = firstDay.getDay();

      calendar.innerHTML = "";

      // æ›œæ—¥
      ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"].forEach(d => {
        const div = document.createElement("div");
        div.innerHTML = `<strong>${d}</strong>`;
        calendar.appendChild(div);
      });

      // ç©ºæ¬„
      for (let i = 0; i < startWeekday; i++) {
        const blank = document.createElement("div");
        calendar.appendChild(blank);
      }

      // æ—¥ä»˜
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        const div = document.createElement("div");
        const holiday = holidays.find(h => h.date === dateStr);
        const dailyMenu = dailyMenus.find(m => m.date === dateStr);
        const event = events.find(e => e.date === dateStr);
        const isHoliday = !!holiday;

        let content = `${day}`;
        let classes = [];

        if (isHoliday) {
          classes.push("holiday");
          if (holiday && holiday.reason) {
            content += `<br><small>${holiday.reason}</small>`;
          }
        } else if (dailyMenu) {
          content += `<br><small>${dailyMenu.food}</small>`;
        }

        // è¡Œäº‹ãƒ»ãŠçŸ¥ã‚‰ã›ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ è¡¨ç¤º
        if (event) {
          if (isHoliday || dailyMenu) {
            content += `<br><small style="color: #007bff;">ğŸ“¢ ${event.message}</small>`;
          } else {
            content = `${day}<br><small style="color: #007bff;">ğŸ“¢ ${event.message}</small>`;
          }
        }

        div.innerHTML = content;
        if (classes.length > 0) {
          div.className = classes.join(' ');
        }
        calendar.appendChild(div);
      }
    }

    // === å®šé£Ÿè¨­å®š ===
    async function addDailyMenu() {
      const date = document.getElementById("daily-menu-date").value;
      const food = document.getElementById("daily-menu-food").value;
      if (!date || !food) return alert("æ—¥ä»˜ã¨å®šé£Ÿãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

      const dailyMenus = await apiGet('daily-menu.php');

      // åŒã˜æ—¥ä»˜ã®è¨­å®šãŒã‚ã‚‹å ´åˆã¯æ›´æ–°ã€ãªã‘ã‚Œã°è¿½åŠ 
      const existingIndex = dailyMenus.findIndex(m => m.date === date);
      if (existingIndex >= 0) {
        dailyMenus[existingIndex].food = food;
      } else {
        dailyMenus.push({ date, food });
      }

      await apiPost('daily-menu.php', dailyMenus);

      document.getElementById("daily-menu-date").value = "";
      document.getElementById("daily-menu-food").value = "";
      loadDailyMenus();
      renderCalendar();
    }

    async function loadDailyMenus() {
      const dailyMenus = await apiGet('daily-menu.php');
      const list = document.getElementById("daily-menu-list");

      if (!dailyMenus || dailyMenus.length === 0) {
        list.innerHTML = "<p>å®šé£Ÿè¨­å®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
      }

      // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
      const sortedMenus = dailyMenus.sort((a, b) => a.date.localeCompare(b.date));

      list.innerHTML = sortedMenus.map(m => {
        const div = document.createElement("div");
        div.className = "menu-item";
        div.innerHTML = `
          <p>ğŸ“… ${m.date}ã€€ğŸ½ï¸ ${m.food}</p>
          <button onclick="deleteDailyMenu('${m.date}')" class="btn btn-danger">å‰Šé™¤</button>
        `;
        return div.outerHTML;
      }).join('');
    }

    async function deleteDailyMenu(date) {
      if (!confirm('ã“ã®å®šé£Ÿè¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      const dailyMenus = await apiGet('daily-menu.php');
      const filtered = dailyMenus.filter(m => m.date !== date);
      await apiPost('daily-menu.php', filtered);
      loadDailyMenus();
      renderCalendar();
    }

    // === è¡Œäº‹ãƒ»ãŠçŸ¥ã‚‰ã›ç®¡ç† ===
    async function addEvent() {
      const date = document.getElementById("event-date").value;
      const message = document.getElementById("event-message").value.trim();
      if (!date || !message) return alert("æ—¥ä»˜ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

      const events = await apiGet('events.php');

      // åŒã˜æ—¥ä»˜ã®è¨­å®šãŒã‚ã‚‹å ´åˆã¯æ›´æ–°ã€ãªã‘ã‚Œã°è¿½åŠ 
      const existingIndex = events.findIndex(e => e.date === date);
      if (existingIndex >= 0) {
        events[existingIndex].message = message;
      } else {
        events.push({ date, message });
      }

      await apiPost('events.php', events);

      document.getElementById("event-date").value = "";
      document.getElementById("event-message").value = "";
      loadEvents();
      renderCalendar();
    }

    async function loadEvents() {
      const events = await apiGet('events.php');
      const list = document.getElementById("events-list");

      if (!events || events.length === 0) {
        list.innerHTML = "<p>è¡Œäº‹ãƒ»ãŠçŸ¥ã‚‰ã›ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>";
        return;
      }

      // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
      const sortedEvents = events.sort((a, b) => a.date.localeCompare(b.date));

      list.innerHTML = sortedEvents.map(e => {
        const div = document.createElement("div");
        div.className = "menu-item";
        div.innerHTML = `
          <p>ğŸ“… ${e.date}ã€€ğŸ“¢ ${e.message}</p>
          <button onclick="deleteEvent('${e.date}')" class="btn btn-danger">å‰Šé™¤</button>
        `;
        return div.outerHTML;
      }).join('');
    }

    async function deleteEvent(date) {
      if (!confirm('ã“ã®è¡Œäº‹ãƒ»ãŠçŸ¥ã‚‰ã›ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      const events = await apiGet('events.php');
      const filtered = events.filter(e => e.date !== date);
      await apiPost('events.php', filtered);
      loadEvents();
      renderCalendar();
    }

    // === äºˆç´„ä¸€è¦§ ===
    async function loadReservations() {
      const list = document.getElementById("reservations-list");
      let reservations = [];
      const isFileProtocol = window.location.protocol === 'file:';
      const apiBase = getApiBase();
      console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] APIãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹:', apiBase);
      console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] ãƒ—ãƒ­ãƒˆã‚³ãƒ«:', window.location.protocol);
      console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] URL:', window.location.href);
      
      try {
        const reservationsUrl = apiBase + 'sales-data.php?reservations=true';
        console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] äºˆç´„å–å¾—URL:', reservationsUrl);
        const raw = await fetch(reservationsUrl, { cache: 'no-store' }).then(r => r.json());
        console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] å–å¾—ãƒ‡ãƒ¼ã‚¿:', raw);
        console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—:', Array.isArray(raw) ? 'é…åˆ—' : typeof raw);
        console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] ğŸ“ èª­ã¿è¾¼ã¿å…ƒ: sales-data.json');
        
        if (Array.isArray(raw)) {
          reservations = raw;
        } else if (raw && Array.isArray(raw.reservations)) {
          reservations = raw.reservations;
        } else {
          reservations = [];
        }
        console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] ğŸ“Š äºˆç´„æ•°:', reservations.length);
        if (reservations.length > 0) {
          console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] ğŸ“‹ äºˆç´„ä¸€è¦§ï¼ˆæœ€åˆã®3ä»¶ï¼‰:', reservations.slice(0, 3));
        }
      } catch (e) {
        console.error('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] âŒ äºˆç´„ä¸€è¦§ã®å–å¾—ã«å¤±æ•—:', e);
        console.error('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
          message: e.message,
          stack: e.stack,
          name: e.name
        });
        let errMsg = 'äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        if (isFileProtocol) {
          errMsg += '<br><strong>â€» ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ã„ã¦ã„ã¾ã™ã€‚</strong> äºˆç´„ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€PHPãŒå‹•ä½œã™ã‚‹Webã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é–‹ã„ã¦ãã ã•ã„ã€‚<br>ä¾‹: <code>http://localhost/admin.html</code> ã¾ãŸã¯ ãƒ¬ãƒ³ã‚¿ãƒ«ã‚µãƒ¼ãƒãƒ¼ã®URLï¼ˆä¾‹: https://ã€‡ã€‡.infinityfreeapp.com/admin.htmlï¼‰';
        } else {
          errMsg += '<br>ã‚¨ãƒ©ãƒ¼: ' + escapeHtml(e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
          errMsg += '<br><br>ğŸ’¡ <strong>InfinityFreeç’°å¢ƒã®å ´åˆã®ç¢ºèªäº‹é …:</strong><br>';
          errMsg += '1. <code>data/</code> ãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ã€æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª<br>';
          errMsg += '2. <code>api/sales-data.php</code> ãŒæ­£ã—ãã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª<br>';
          errMsg += '3. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ã‚­ãƒ¼ï¼‰ã§è©³ç´°ãªã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª<br>';
          errMsg += '4. ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã€Œäºˆç´„ä¸€è¦§ã‚’æ›´æ–°ã€ã‚’æŠ¼ã™ã‹ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
        }
        list.innerHTML = "<div style='color:#dc3545; padding:15px; background:#fff3cd; border:2px solid #ffc107; border-radius:8px;'>" + errMsg + "</div>";
        return;
      }
      if (reservations.length === 0) {
        let emptyMsg = 'äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆ0ä»¶ï¼‰ã€‚';
        emptyMsg += '<br>äºˆç´„ã‚µã‚¤ãƒˆï¼ˆ<a href="book.html">book.html</a>ï¼‰ã§äºˆç´„ã—ãŸå¾Œã€ã€Œäºˆç´„ä¸€è¦§ã‚’æ›´æ–°ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        if (isFileProtocol) {
          emptyMsg += '<br><span style="color:#856404;"><strong>â€» ãƒ•ã‚¡ã‚¤ãƒ«ã§ç›´æ¥é–‹ã„ã¦ã„ã‚‹ã¨äºˆç´„ã¯ä¿å­˜ãƒ»è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</strong> Webã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é–‹ã„ã¦ãã ã•ã„ã€‚</span>';
        } else {
          emptyMsg += '<br><br>ğŸ’¡ <strong>InfinityFreeç’°å¢ƒã®å ´åˆ:</strong><br>';
          emptyMsg += '- äºˆç´„ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª: <code>data/sales-data.json</code> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª<br>';
          emptyMsg += '- APIãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª: ãƒ–ãƒ©ã‚¦ã‚¶ã§ <code>' + apiBase + 'sales-data.php?reservations=true</code> ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦JSONãŒè¿”ã‚‹ã‹ç¢ºèª';
        }
        list.innerHTML = "<div style='color:#666; padding:15px; background:#f8f9fa; border:1px solid #ddd; border-radius:8px;'>" + emptyMsg + "</div>";
        return;
      }

      // === ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ===
      const dateEl = document.getElementById('admin-filter-date');
      const modeEl = document.getElementById('admin-filter-mode');
      const qEl = document.getElementById('admin-filter-q');
      const selectedDate = (dateEl && dateEl.value) ? dateEl.value : getTodayIso();
      const mode = modeEl ? modeEl.value : 'all'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ã€Œã™ã¹ã¦ã€ã«å¤‰æ›´
      const q = qEl ? String(qEl.value || '').trim().toLowerCase() : '';

      const isVerifiedFn = (r) => r && (r.verified === true || r.verified === 'true' || r.verified === 1);

      console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š:', {
        mode: mode,
        selectedDate: selectedDate,
        searchQuery: q,
        totalReservations: reservations.length
      });

      let filtered = reservations;
      if (mode === 'today') {
        filtered = filtered.filter(r => String(r.date || '') === selectedDate);
        console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] ğŸ“… æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œ:', filtered.length, 'ä»¶ï¼ˆæŒ‡å®šæ—¥:', selectedDate, 'ï¼‰');
      } else if (mode === 'unverified') {
        filtered = filtered.filter(r => !isVerifiedFn(r));
        console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] ğŸ” æœªèªè¨¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œ:', filtered.length, 'ä»¶');
      } else if (mode === 'verified') {
        filtered = filtered.filter(r => isVerifiedFn(r));
        console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] âœ… èªè¨¼æ¸ˆã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œ:', filtered.length, 'ä»¶');
      } else if (mode === 'all') {
        console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] ğŸ“‹ ã™ã¹ã¦è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—ï¼‰');
      }
      if (q) {
        const beforeSearch = filtered.length;
        filtered = filtered.filter(r => {
          const name = String(r.name || '').toLowerCase();
          const cls = String(r.studentClass || '').toLowerCase();
          const food = String(r.food || '').toLowerCase();
          const num = (r.reservationNumber != null ? String(r.reservationNumber) : '');
          return name.includes(q) || cls.includes(q) || food.includes(q) || num.includes(q);
        });
        console.log('[ç®¡ç†ç”»é¢ãƒ‡ãƒãƒƒã‚°] ğŸ” æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œ:', filtered.length, 'ä»¶ï¼ˆæ¤œç´¢å‰:', beforeSearch, 'ä»¶, æ¤œç´¢èª:', q, 'ï¼‰');
      }

      if (filtered.length === 0) {
        let filterMsg = '';
        if (reservations.length > 0) {
          filterMsg = `<p style='color:#856404; font-weight:bold; margin-bottom:10px;'>âš ï¸ å…¨äºˆç´„æ•°: ${reservations.length}ä»¶ã‚ã‚Šã¾ã™ãŒã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
          if (mode === 'today') {
            filterMsg += `<p style='color:#666;'>ğŸ’¡ ã€Œè¡¨ç¤ºã€ã‚’ã€Œã™ã¹ã¦ã€ã«å¤‰æ›´ã™ã‚‹ã‹ã€æ—¥ä»˜ã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>`;
            filterMsg += `<p style='color:#666; font-size:14px;'>ç¾åœ¨ã®è¨­å®š: æ—¥ä»˜=${selectedDate}, è¡¨ç¤º=${mode}</p>`;
          } else {
            filterMsg += `<p style='color:#666;'>ğŸ’¡ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>`;
            filterMsg += `<p style='color:#666; font-size:14px;'>ç¾åœ¨ã®è¨­å®š: è¡¨ç¤º=${mode}${q ? ', æ¤œç´¢=' + q : ''}</p>`;
          }
        } else {
          filterMsg = "<p style='color:#666;'>äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆ0ä»¶ï¼‰ã€‚</p>";
        }
        list.innerHTML = "<div style='color:#666; padding:15px; background:#fff3cd; border:2px solid #ffc107; border-radius:8px;'>" + filterMsg + "</div>";
        return;
      }

      // æ—¥ä»˜ãƒ»æ™‚é–“ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
      filtered = [...filtered].sort((a, b) => {
        const dateA = (a.date || '') + ' ' + (a.time || '');
        const dateB = (b.date || '') + ' ' + (b.time || '');
        return dateB.localeCompare(dateA);
      });

      // ä¸€è¦§è¡¨ï¼ˆèª°ãŒãƒ»ä½•ã‚’ãƒ»ã„ã¤äºˆç´„ã—ãŸã‹ãŒä¸€ç›®ã§ã‚ã‹ã‚‹ï¼‰
      const verifiedCount = filtered.filter(isVerifiedFn).length;
      const unverifiedCount = filtered.length - verifiedCount;
      const tableRows = filtered.map(r => {
        const name = escapeHtml(String(r.name || '').trim() || 'â€”');
        const cls = escapeHtml(String(r.studentClass || '').trim() || 'â€”');
        const food = escapeHtml(String(r.food || '').trim() || 'â€”');
        const date = escapeHtml(String(r.date || 'â€”'));
        const time = escapeHtml(String(r.time || 'â€”'));
        const num = r.reservationNumber != null ? r.reservationNumber : 'â€”';
        const isVerified = isVerifiedFn(r);
        const verifiedMark = isVerified ? '<span style="color: #28a745;">âœ…</span>' : 'â€”';
        return `
          <tr style="background-color: ${isVerified ? '#f0fff0' : '#fff'};">
            <td style="border: 1px solid #ddd; padding: 10px;">${date}</td>
            <td style="border: 1px solid #ddd; padding: 10px;">${time}</td>
            <td style="border: 1px solid #ddd; padding: 10px; font-weight: bold;">${name}</td>
            <td style="border: 1px solid #ddd; padding: 10px;">${cls}</td>
            <td style="border: 1px solid #ddd; padding: 10px;">${food}</td>
            <td style="border: 1px solid #ddd; padding: 10px;">${num}</td>
            <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${verifiedMark}</td>
          </tr>
        `;
      }).join('');

      let html = `
        <div style="margin-bottom: 20px;">
          <h4 style="margin: 0 0 10px 0; color: #333;">ğŸ“‹ äºˆç´„ä¸€è¦§ï¼ˆåå‰ãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»æ—¥ä»˜ï¼‰</h4>
          <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">
            è¡¨ç¤ºä»¶æ•°: <strong>${filtered.length}</strong> ä»¶ / å…¨äºˆç´„æ•°: <strong>${reservations.length}</strong> ä»¶ï¼ˆæœªèªè¨¼: <strong>${unverifiedCount}</strong> / èªè¨¼æ¸ˆã¿: <strong>${verifiedCount}</strong>ï¼‰
            ${filtered.length < reservations.length ? `<span style="color:#856404;">âš ï¸ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ ${reservations.length - filtered.length} ä»¶ãŒéè¡¨ç¤º</span>` : ''}
          </p>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
              <thead>
                <tr style="background-color: #f8f9fa;">
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">æ—¥ä»˜</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">æ™‚é–“</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">äºˆç´„è€…å</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">ã‚¯ãƒ©ã‚¹</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">äºˆç´„ãƒ¡ãƒ‹ãƒ¥ãƒ¼</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">äºˆç´„ç•ªå·</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">èªè¨¼</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
        </div>
      `;

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆå¾“æ¥ã®è¡¨ç¤ºã‚‚æ®‹ã™ï¼‰
      const grouped = {};
      filtered.forEach(r => {
        const foodKey = (r.food && String(r.food).trim()) ? r.food : 'ï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼æœªè¨­å®šï¼‰';
        if (!grouped[foodKey]) grouped[foodKey] = [];
        grouped[foodKey].push(r);
      });

      Object.keys(grouped).forEach(food => {
        grouped[food].sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ja'));
      });

      const sortedFoods = Object.keys(grouped).sort();
      html += '<h4 style="margin: 20px 0 10px 0; color: #333;">ğŸ½ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥ã®äººæ•°</h4>';
      html += sortedFoods.map(food => {
        const reservationsForFood = grouped[food];
        const verifiedCount = reservationsForFood.filter(isVerifiedFn).length;
        const totalCount = reservationsForFood.length;

        const peopleList = reservationsForFood.map(r => {
          const isVerified = isVerifiedFn(r);
          const displayName = escapeHtml(String(r.name || '').trim() || 'ï¼ˆåå‰ãªã—ï¼‰');
          const displayClass = escapeHtml(String(r.studentClass || '').trim());
          const checkboxId = 'verified-' + (r.id || r.name || '') + '-' + (r.reservationNumber || '') + '-' + Math.random().toString(36).slice(2);
          return `
            <div style="display: flex; align-items: center; margin-bottom: 5px; padding: 5px; background-color: ${isVerified ? '#d4edda' : '#fff'}; border-radius: 4px; border: 1px solid ${isVerified ? '#c3e6cb' : '#ddd'};">
              <input type="checkbox" id="${checkboxId}" ${isVerified ? 'checked' : ''} disabled style="margin-right: 10px; transform: scale(1.5); cursor: not-allowed; accent-color: #28a745;">
              <label for="${checkboxId}" style="margin: 0; cursor: default; flex: 1; color: ${isVerified ? '#155724' : '#333'};">
                <strong>${displayName}</strong>
                ${displayClass ? ' <span style="color:#666;">ï¼ˆ' + displayClass + 'ï¼‰</span>' : ''}
                ${r.reservationNumber != null ? 'ï¼ˆäºˆç´„ç•ªå·: ' + r.reservationNumber + 'ï¼‰' : ''}
                ${r.date ? 'ã€€' + escapeHtml(r.date) : ''}
                ${isVerified ? ' âœ…' : ''}
              </label>
            </div>
          `;
        }).join('');

        return `
          <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
            <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #333;">ğŸ½ï¸ ${escapeHtml(food)}</h3>
            <div style="margin-bottom: 8px;">
              ${peopleList}
            </div>
            <p style="margin: 0; font-size: 16px; font-weight: bold; color: #e74c3c;">
              ğŸ‘¥ ${totalCount}äºº
              ${verifiedCount > 0 ? '<span style="color: #28a745;">âœ… èªè¨¼æ¸ˆã¿: ' + verifiedCount + 'äºº</span>' : ''}
            </p>
          </div>
        `;
      }).join('');

      list.innerHTML = html;
    }

    // === ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ ===
    async function loadReviews() {
      try {
        const reviews = await apiGet('reviews.php');
        const list = document.getElementById("reviews-list");

        if (!reviews || reviews.length === 0) {
          list.innerHTML = "<p>ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
          return;
        }

        list.innerHTML = reviews.map(review => {
          const name = review.name && review.name.trim() ? review.name : 'åŒ¿å';
          const date = review.date || 'æ—¥ä»˜ä¸æ˜';
          const comment = review.comment || '';

          return `
            <div style="margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #f8f9fa;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                  <strong style="font-size: 16px; color: #333;">${escapeHtml(name)}</strong>
                  <span style="font-size: 14px; color: #666; margin-left: 10px;">${escapeHtml(date)}</span>
                </div>
                <button onclick="deleteReview(${review.id})" class="btn btn-danger" style="padding: 6px 12px; font-size: 14px;">å‰Šé™¤</button>
              </div>
              <div style="color: #555; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(comment)}</div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('ãƒ¬ãƒ“ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById("reviews-list").innerHTML =
          '<p style="color: red;">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
      }
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getTodayIso() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤
    async function deleteReview(reviewId) {
      if (!confirm('ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        const response = await fetch('api/reviews.php', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ id: reviewId })
        });

        if (!response.ok) {
          throw new Error('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
        loadReviews();
      } catch (error) {
        console.error('ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }


    // === äºˆç´„æ™‚é–“ç®¡ç† ===
    let timeSlotCounter = 0;

    function addTimeSlot(startTime = '', endTime = '') {
      const container = document.getElementById('time-slots-container');
      const slotId = `time-slot-${timeSlotCounter++}`;
      const slotDiv = document.createElement('div');
      slotDiv.id = slotId;
      slotDiv.className = 'time-slot-item';
      slotDiv.style.cssText = 'margin-bottom: 15px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;';
      slotDiv.innerHTML = `
        <div style="display: flex; gap: 10px; align-items: flex-end;">
          <div class="form-group" style="flex: 1;">
            <label>é–‹å§‹æ™‚é–“:</label>
            <input type="time" class="slot-start-time" value="${startTime}" required>
          </div>
          <div class="form-group" style="flex: 1;">
            <label>çµ‚äº†æ™‚é–“:</label>
            <input type="time" class="slot-end-time" value="${endTime}" required>
          </div>
          <button onclick="removeTimeSlot('${slotId}')" class="btn btn-danger" style="margin-bottom: 0;">å‰Šé™¤</button>
        </div>
      `;
      container.appendChild(slotDiv);
    }

    function removeTimeSlot(slotId) {
      const slot = document.getElementById(slotId);
      if (slot) {
        slot.remove();
      }
    }

    async function loadReservationTimes() {
      try {
        const times = await apiGet('reservation-times.php');
        const displayDiv = document.getElementById('reservation-times-display');
        const container = document.getElementById('time-slots-container');

        // å¾Œæ–¹äº’æ›æ€§: å¤ã„å½¢å¼ã‚’æ–°ã—ã„å½¢å¼ã«å¤‰æ›
        let timeSlots = [];
        if (times) {
          if (times.timeSlots && Array.isArray(times.timeSlots)) {
            timeSlots = times.timeSlots;
          } else if (times.startTime && times.endTime) {
            timeSlots = [{ startTime: times.startTime, endTime: times.endTime }];
          }
        }

        // è¡¨ç¤ºã‚’æ›´æ–°
        if (times && timeSlots.length > 0) {
          const timeStrings = timeSlots.map(slot => `${slot.startTime} - ${slot.endTime}`).join(', ');
          displayDiv.innerHTML = `
            <div style="padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
              <p><strong>â° äºˆç´„å¯èƒ½æ™‚é–“:</strong> ${timeStrings}</p>
              <p><strong>ğŸ“ çŠ¶æ…‹:</strong> ${times.enabled ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹'}</p>
              <p><strong>ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${times.message || ''}</p>
            </div>
          `;

          // ãƒ•ã‚©ãƒ¼ãƒ ã«ç¾åœ¨ã®å€¤ã‚’è¨­å®š
          container.innerHTML = '';
          timeSlots.forEach(slot => {
            addTimeSlot(slot.startTime || '', slot.endTime || '');
          });
          document.getElementById('reservation-message').value = times.message || '';
        } else {
          displayDiv.innerHTML = '<p style="color: #666;">äºˆç´„æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
          container.innerHTML = '';
          addTimeSlot();
        }
      } catch (error) {
        console.error('äºˆç´„æ™‚é–“è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('reservation-times-display').innerHTML =
          '<p style="color: red;">äºˆç´„æ™‚é–“è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
      }
    }

    async function updateReservationTimes() {
      const slotItems = document.querySelectorAll('.time-slot-item');
      const timeSlots = [];

      // å„æ™‚é–“å¸¯ã‚’åé›†
      for (const item of slotItems) {
        const startTime = item.querySelector('.slot-start-time').value;
        const endTime = item.querySelector('.slot-end-time').value;

        if (!startTime || !endTime) {
          alert('ã™ã¹ã¦ã®æ™‚é–“å¸¯ã®é–‹å§‹æ™‚é–“ã¨çµ‚äº†æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        if (startTime >= endTime) {
          alert('é–‹å§‹æ™‚é–“ã¯çµ‚äº†æ™‚é–“ã‚ˆã‚Šæ—©ãè¨­å®šã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        timeSlots.push({ startTime, endTime });
      }

      if (timeSlots.length === 0) {
        alert('å°‘ãªãã¨ã‚‚1ã¤ã®æ™‚é–“å¸¯ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      const message = document.getElementById('reservation-message').value.trim();
      const timeStrings = timeSlots.map(slot => `${slot.startTime}-${slot.endTime}`).join(', ');

      try {
        const data = {
          timeSlots: timeSlots,
          enabled: true, // è¨­å®šã•ã‚ŒãŸã‚‰è‡ªå‹•çš„ã«æœ‰åŠ¹
          message: message || `äºˆç´„æ™‚é–“: ${timeStrings}`
        };

        await apiPost('reservation-times.php', data);
        alert('äºˆç´„æ™‚é–“è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸï¼\näºˆç´„æ™‚é–“åˆ¶é™ãŒè‡ªå‹•çš„ã«æœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚');
        loadReservationTimes();
      } catch (error) {
        console.error('äºˆç´„æ™‚é–“è¨­å®šã®æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        alert('äºˆç´„æ™‚é–“è¨­å®šã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.message || ''));
      }
    }

    // === æœˆé–“ãƒ¬ãƒãƒ¼ãƒˆ ===
    async function generateReport() {
      const year = document.getElementById('report-year').value;
      const month = document.getElementById('report-month').value;

      try {
        const response = await fetch(`api/monthly-report.php?year=${year}&month=${month}`);
        const report = await response.json();

        displayReport(report);
      } catch (error) {
        console.error('ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }

    function generateMenuSalesTable(menuSales) {
      const menuEntries = Object.entries(menuSales);

      if (menuEntries.length === 0) {
        return '<p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      }

      // å£²ä¸Šæ•°ã§ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰
      menuEntries.sort((a, b) => b[1] - a[1]);

      return `
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
          <tr style="background-color: #f8f9fa;">
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼å</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">å£²ä¸Šæ•°ï¼ˆå€‹ï¼‰</th>
          </tr>
          ${menuEntries.map(([menu, quantity]) => `
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;">${menu}</td>
              <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold;">${quantity}</td>
            </tr>
          `).join('')}
        </table>
      `;
    }

    function displayReport(report) {
      const reportDiv = document.getElementById('report-display');

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šã®ãƒˆãƒƒãƒ—5
      const topMenuItems = Object.entries(report.topMenu || {})
        .map(([menu, quantity]) => `<li>${menu}: ${quantity}å€‹</li>`)
        .join('');

      // æ—¥åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿
      const dailyData = report.dailySales || [];
      const dailyTable = dailyData.length > 0 ? `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 600px;">
            <tr style="background-color: #f8f9fa;">
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">æ—¥ä»˜</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">äºˆç´„æ•°</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">æ¥å®¢æ•°</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Š</th>
            </tr>
            ${dailyData.map(day => {
        const menuSales = day.menuSales || {};
        let menuSalesText = '';
        if (Object.keys(menuSales).length > 0) {
          const menuEntries = Object.entries(menuSales)
            .sort((a, b) => b[1] - a[1])
            .map(([menu, qty]) => `<span style="display: inline-block; margin-right: 10px; margin-bottom: 4px; padding: 3px 8px; background-color: #e3f2fd; border-radius: 4px; font-size: 12px;"><strong>${menu}</strong>: ${qty}å€‹</span>`);
          menuSalesText = menuEntries.join('');
        } else {
          menuSalesText = '<span style="color: #999;">ãƒ‡ãƒ¼ã‚¿ãªã—</span>';
        }

        return `
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${day.date}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${day.reservations}äºº</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold; color: #28a745;">${day.people}äºº</td>
                <td style="border: 1px solid #ddd; padding: 8px; line-height: 1.8;">${menuSalesText}</td>
              </tr>
            `;
      }).join('')}
          </table>
        </div>
      ` : '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';

      reportDiv.innerHTML = `
        <div style="padding: 20px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; margin-top: 15px;">
          <h3 style="color: #333; margin-top: 0;">ğŸ“Š ${report.year}å¹´${report.month}æœˆ æœˆé–“ãƒ¬ãƒãƒ¼ãƒˆ</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 5px 0; color: #666;">ç·å–¶æ¥­æ—¥æ•°</h4>
              <p style="font-size: 24px; font-weight: bold; color: #007bff; margin: 0;">${report.totalDays}æ—¥</p>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 5px 0; color: #666;">ç·äºˆç´„æ•°</h4>
              <p style="font-size: 24px; font-weight: bold; color: #28a745; margin: 0;">${report.totalReservations}äºº</p>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 5px 0; color: #666;">ç·æ¥å®¢æ•°</h4>
              <p style="font-size: 24px; font-weight: bold; color: #dc3545; margin: 0;">${report.totalPeople}äºº</p>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 5px 0; color: #666;">1æ—¥å¹³å‡æ¥å®¢æ•°</h4>
              <p style="font-size: 24px; font-weight: bold; color: #ffc107; margin: 0;">${report.averageDailyPeople}äºº</p>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4>ğŸ† äººæ°—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ TOP5</h4>
            <ul>${topMenuItems}</ul>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4>ğŸ½ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¥å£²ä¸Šæ•°</h4>
            ${generateMenuSalesTable(report.menuSales || {})}
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4>ğŸ“… æ—¥åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿</h4>
            ${dailyTable}
          </div>
          
          <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
            <h4 style="margin-top: 0;">ğŸ“ˆ åˆ†æçµæœ</h4>
            <p><strong>æœ€ã‚‚å¿™ã—ã‹ã£ãŸæ—¥:</strong> ${report.busiestDay || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</p>
            <p><strong>æœ€ã‚‚å¿™ã—ã‹ã£ãŸæ™‚é–“å¸¯:</strong> ${report.busiestTimeSlot || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</p>
          </div>
        </div>
      `;
    }

    async function downloadReport() {
      const year = document.getElementById('report-year').value;
      const month = document.getElementById('report-month').value;

      try {
        const response = await fetch(`api/monthly-report.php?year=${year}&month=${month}&format=csv`);
        const csvData = await response.text();

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `monthly_report_${year}_${month.toString().padStart(2, '0')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        alert('ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
      } catch (error) {
        console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }

    // === AIåˆ†æ ===
    async function performAIAnalysis() {
      const year = document.getElementById('ai-analysis-year').value;
      const month = document.getElementById('ai-analysis-month').value;
      const displayDiv = document.getElementById('ai-analysis-display');

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      displayDiv.innerHTML = `
        <div style="padding: 20px; text-align: center; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
          <p style="font-size: 18px; color: #666;">ğŸ¤– AIåˆ†æã‚’å®Ÿè¡Œä¸­...</p>
          <p style="color: #999; margin-top: 10px;">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ï¼ˆ30ç§’ã€œ2åˆ†ç¨‹åº¦ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰</p>
        </div>
      `;

      try {
        const response = await fetch(`api/ai-analysis.php?year=${year}&month=${month}`);
        const result = await response.json();

        if (result.error) {
          displayDiv.innerHTML = `
            <div style="padding: 20px; background-color: #fff3cd; border-radius: 8px; border: 1px solid #ffc107; margin-top: 15px;">
              <h4 style="color: #856404; margin-top: 0;">âš ï¸ ã‚¨ãƒ©ãƒ¼</h4>
              <p style="color: #856404;">${result.error}</p>
              <p style="color: #856404; font-size: 14px; margin-top: 10px;">
                AI APIã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ollama-config.phpã§OpenAIã€Geminiã€ã¾ãŸã¯Groqã®APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
              </p>
            </div>
          `;
          return;
        }

        if (result.analysis) {
          // Markdownå½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’HTMLã«å¤‰æ›ï¼ˆç°¡æ˜“ç‰ˆï¼‰
          let analysisHtml = result.analysis
            .replace(/\n/g, '<br>')
            .replace(/## (.*?)(<br>|$)/g, '<h3 style="color: #333; margin-top: 20px; margin-bottom: 10px;">$1</h3>')
            .replace(/### (.*?)(<br>|$)/g, '<h4 style="color: #555; margin-top: 15px; margin-bottom: 8px;">$1</h4>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/âœ…/g, '<span style="color: #28a745;">âœ…</span>')
            .replace(/ğŸ”§/g, '<span style="color: #ffc107;">ğŸ”§</span>')
            .replace(/ğŸ’¡/g, '<span style="color: #17a2b8;">ğŸ’¡</span>')
            .replace(/ğŸ“Š/g, '<span style="color: #007bff;">ğŸ“Š</span>');

          displayDiv.innerHTML = `
            <div style="padding: 20px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; margin-top: 15px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #333; margin: 0;">ğŸ¤– AIåˆ†æçµæœ - ${year}å¹´${month}æœˆ</h3>
                <span style="font-size: 12px; color: #666; background-color: white; padding: 4px 8px; border-radius: 4px;">
                  ä½¿ç”¨API: ${result.api || 'ä¸æ˜'}
                </span>
              </div>
              <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #ddd; line-height: 1.8; color: #333;">
                ${analysisHtml}
              </div>
            </div>
          `;
        } else {
          displayDiv.innerHTML = `
            <div style="padding: 20px; background-color: #fff3cd; border-radius: 8px; border: 1px solid #ffc107; margin-top: 15px;">
              <h4 style="color: #856404; margin-top: 0;">âš ï¸ ã‚¨ãƒ©ãƒ¼</h4>
              <p style="color: #856404;">åˆ†æçµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('AIåˆ†æã‚¨ãƒ©ãƒ¼:', error);
        displayDiv.innerHTML = `
          <div style="padding: 20px; background-color: #f8d7da; border-radius: 8px; border: 1px solid #dc3545; margin-top: 15px;">
            <h4 style="color: #721c24; margin-top: 0;">âŒ ã‚¨ãƒ©ãƒ¼</h4>
            <p style="color: #721c24;">AIåˆ†æã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
            <p style="color: #721c24; font-size: 14px; margin-top: 10px;">ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}</p>
          </div>
        `;
      }
    }

    // === ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ===
    function switchTab(tabName, buttonElement) {
      // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });

      // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤º
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      if (buttonElement) {
        buttonElement.classList.add('active');
      }
    }

    // === ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³åˆ‡ã‚Šæ›¿ãˆ ===
    function toggleAccordion(header) {
      const content = header.nextElementSibling;
      const isActive = content.classList.contains('active');

      // ã™ã¹ã¦ã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‰ã˜ã‚‹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šä»–ã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‹ã„ãŸã¾ã¾ã«ã™ã‚‹å ´åˆã¯å‰Šé™¤ï¼‰
      // document.querySelectorAll('.accordion-content').forEach(acc => {
      //   acc.classList.remove('active');
      //   acc.previousElementSibling.classList.remove('active');
      // });

      if (isActive) {
        content.classList.remove('active');
        header.classList.remove('active');
      } else {
        content.classList.add('active');
        header.classList.add('active');
      }
    }

    // === ã‚·ãƒ•ãƒˆè¡¨ç®¡ç† ===
    async function addShift() {
      const date = document.getElementById("shift-date").value;
      const name = document.getElementById("shift-name").value.trim();
      const startTime = document.getElementById("shift-start-time").value;
      const endTime = document.getElementById("shift-end-time").value;
      const role = document.getElementById("shift-role").value.trim();

      if (!date || !name || !startTime || !endTime) {
        return alert("æ—¥ä»˜ã€æ‹…å½“è€…åã€é–‹å§‹æ™‚é–“ã€çµ‚äº†æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      }

      if (startTime >= endTime) {
        return alert("é–‹å§‹æ™‚é–“ã¯çµ‚äº†æ™‚é–“ã‚ˆã‚Šæ—©ãè¨­å®šã—ã¦ãã ã•ã„ã€‚");
      }

      const shifts = await apiGet('shifts.php');

      const newShift = {
        id: Date.now(),
        date: date,
        name: name,
        startTime: startTime,
        endTime: endTime,
        role: role || ''
      };

      shifts.push(newShift);
      await apiPost('shifts.php', shifts);

      document.getElementById("shift-date").value = "";
      document.getElementById("shift-name").value = "";
      document.getElementById("shift-start-time").value = "";
      document.getElementById("shift-end-time").value = "";
      document.getElementById("shift-role").value = "";
      loadShifts();
    }

    // å¾“æ¥­å“¡åãƒªã‚¹ãƒˆã‚’ç®¡ç†
    let employeeNamesList = [];

    async function loadEmployeeNames() {
      const shifts = await apiGet('shifts.php');
      const existingNames = [...new Set(shifts.map(s => s.name))];

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾“æ¥­å“¡åãƒªã‚¹ãƒˆã‚’å–å¾—
      const storedNames = localStorage.getItem('shift_employee_names');
      if (storedNames) {
        const parsedNames = JSON.parse(storedNames);
        employeeNamesList = [...new Set([...parsedNames, ...existingNames])].sort();
      } else {
        employeeNamesList = existingNames.sort();
      }
    }

    async function addEmployeeName() {
      const nameInput = document.getElementById("shift-employee-name");
      const name = nameInput.value.trim();

      if (!name) {
        return alert("å¾“æ¥­å“¡åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      }

      if (employeeNamesList.includes(name)) {
        return alert("ã“ã®å¾“æ¥­å“¡åã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚");
      }

      employeeNamesList.push(name);
      employeeNamesList.sort();

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
      localStorage.setItem('shift_employee_names', JSON.stringify(employeeNamesList));

      nameInput.value = "";
      loadShifts();
    }

    async function loadShifts() {
      await loadEmployeeNames();
      const shifts = await apiGet('shifts.php');
      const list = document.getElementById("shifts-list");
      const monthInput = document.getElementById("shift-display-month");

      // ç¾åœ¨ã®æœˆã‚’è¨­å®šï¼ˆåˆå›ã®ã¿ï¼‰
      if (!monthInput.value) {
        const today = new Date();
        monthInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
      }

      const selectedMonth = monthInput.value;
      const [year, month] = selectedMonth.split('-').map(Number);

      // æœˆã®æ—¥æ•°ã‚’å–å¾—
      const daysInMonth = new Date(year, month, 0).getDate();

      // é¸æŠã•ã‚ŒãŸæœˆã®ã‚·ãƒ•ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const monthShifts = shifts.filter(shift => {
        const shiftDate = new Date(shift.date);
        return shiftDate.getFullYear() === year && shiftDate.getMonth() + 1 === month;
      });

      // å¾“æ¥­å“¡åã®ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ï¼ˆã‚·ãƒ•ãƒˆãŒãªã„å¾“æ¥­å“¡ã‚‚è¡¨ç¤ºï¼‰
      if (employeeNamesList.length === 0) {
        list.innerHTML = `<p style="padding: 20px; text-align: center; color: #666;">å¾“æ¥­å“¡åã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚å¾“æ¥­å“¡åã‚’è¿½åŠ ã™ã‚‹ã¨ã€ã‚·ãƒ•ãƒˆè¡¨ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>`;
        return;
      }

      // æ—¥ä»˜ã”ã¨ã®ã‚·ãƒ•ãƒˆã‚’æ•´ç†
      const shiftsByDateAndName = {};
      monthShifts.forEach(shift => {
        const day = new Date(shift.date).getDate();
        if (!shiftsByDateAndName[day]) {
          shiftsByDateAndName[day] = {};
        }
        if (!shiftsByDateAndName[day][shift.name]) {
          shiftsByDateAndName[day][shift.name] = [];
        }
        shiftsByDateAndName[day][shift.name].push(shift);
      });

      // æ¨ªã®è¡¨å½¢å¼ã§è¡¨ç¤º
      let html = '<div style="overflow-x: auto; margin-top: 15px;">';
      html += '<table style="border-collapse: collapse; font-size: 12px; min-width: 1200px;">';

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ1: æ—¥ä»˜
      html += '<tr style="background-color: #f0f0f0;">';
      html += '<th style="border: 1px solid #ccc; padding: 8px; text-align: center; position: sticky; left: 0; background-color: #f0f0f0; z-index: 10;">æ°å</th>';
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
        const isWeekend = dayOfWeek === 'æ—¥' || dayOfWeek === 'åœŸ';
        html += `<th style="border: 1px solid #ccc; padding: 4px; text-align: center; min-width: 30px; ${isWeekend ? 'background-color: #fff5f5;' : ''}">${day}</th>`;
      }
      html += '<th style="border: 1px solid #ccc; padding: 8px; text-align: center; background-color: #e8f4f8;">åˆè¨ˆ<br>å‡ºå‹¤æ—¥æ•°</th>';
      html += '<th style="border: 1px solid #ccc; padding: 8px; text-align: center; position: sticky; right: 0; background-color: #f0f0f0; z-index: 10;">æ“ä½œ</th>';
      html += '</tr>';

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ2: æ›œæ—¥
      html += '<tr style="background-color: #f8f8f8;">';
      html += '<th style="border: 1px solid #ccc; padding: 4px; text-align: center; position: sticky; left: 0; background-color: #f8f8f8; z-index: 10;"></th>';
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
        const isWeekend = dayOfWeek === 'æ—¥' || dayOfWeek === 'åœŸ';
        html += `<th style="border: 1px solid #ccc; padding: 2px; text-align: center; font-size: 10px; ${isWeekend ? 'background-color: #fff5f5; color: #d00;' : ''}">${dayOfWeek}</th>`;
      }
      html += '<th style="border: 1px solid #ccc; padding: 4px; text-align: center; background-color: #e8f4f8;"></th>';
      html += '<th style="border: 1px solid #ccc; padding: 4px; text-align: center; position: sticky; right: 0; background-color: #f8f8f8; z-index: 10;"></th>';
      html += '</tr>';

      // å¾“æ¥­å“¡ã”ã¨ã®è¡Œ
      employeeNamesList.forEach((name, nameIndex) => {
        let attendanceDays = 0;

        // é€šå¸¸ã‚·ãƒ•ãƒˆè¡Œ
        html += '<tr>';
        html += `<td style="border: 1px solid #ccc; padding: 6px; text-align: left; position: sticky; left: 0; background-color: white; z-index: 5; font-weight: bold;">${escapeHtml(name)}<br><small style="color: #666;">é€šå¸¸</small></td>`;

        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month - 1, day);
          const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
          const isWeekend = dayOfWeek === 'æ—¥' || dayOfWeek === 'åœŸ';
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

          const dayShifts = shiftsByDateAndName[day]?.[name] || [];
          const normalShifts = dayShifts.filter(s => !s.symbol || (s.symbol !== 'H' && s.role !== 'Hæ®‹æ¥­'));

          let cellContent = '';
          let currentSymbol = '';
          if (normalShifts.length > 0) {
            attendanceDays++;
            const shift = normalShifts[0];
            currentSymbol = shift.symbol || (shift.role || 'ã€‡');
            cellContent = escapeHtml(currentSymbol);
            if (normalShifts.length > 1) {
              cellContent += `(${normalShifts.length})`;
            }
          }

          html += `<td onclick="openShiftSymbolSelector('${escapeHtml(name)}', '${dateStr}', 'normal', ${day}, '${currentSymbol}')" style="border: 1px solid #ccc; padding: 4px; text-align: center; cursor: pointer; ${isWeekend ? 'background-color: #fff5f5;' : ''} min-height: 30px;" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨˜å·ã‚’é¸æŠ">${cellContent || '&nbsp;'}</td>`;
        }

        html += `<td style="border: 1px solid #ccc; padding: 6px; text-align: center; background-color: #e8f4f8; font-weight: bold;">${attendanceDays}æ—¥</td>`;

        // æ“ä½œåˆ—ï¼ˆæœ€åˆã®è¡Œã®ã¿ï¼‰
        if (nameIndex === 0) {
          html += `<td rowspan="${employeeNamesList.length * 2}" style="border: 1px solid #ccc; padding: 8px; text-align: center; position: sticky; right: 0; background-color: white; z-index: 5; vertical-align: top;">
            <button onclick="deleteAllShiftsForEmployee('${escapeHtml(name)}', ${year}, ${month})" class="btn btn-danger" style="padding: 4px 8px; font-size: 11px; margin-bottom: 5px;">å…¨å‰Šé™¤</button>
          </td>`;
        }
        html += '</tr>';

        // Hæ®‹æ¥­è¡Œï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
        const hasOvertime = monthShifts.some(s => s.name === name && (s.symbol === 'H' || s.role === 'Hæ®‹æ¥­'));
        // å¸¸ã«Hæ®‹æ¥­è¡Œã‚’è¡¨ç¤º
        {
          html += '<tr>';
          html += `<td style="border: 1px solid #ccc; padding: 6px; text-align: left; position: sticky; left: 0; background-color: #fafafa; z-index: 5;"><small style="color: #666;">Hæ®‹æ¥­</small></td>`;

          for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month - 1, day);
            const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
            const isWeekend = dayOfWeek === 'æ—¥' || dayOfWeek === 'åœŸ';

            const dayShifts = shiftsByDateAndName[day]?.[name] || [];
            const overtimeShifts = dayShifts.filter(s => s.symbol === 'H' || s.role === 'Hæ®‹æ¥­');

            let cellContent = '';
            let currentSymbol = '';
            if (overtimeShifts.length > 0) {
              currentSymbol = 'H';
              cellContent = 'H';
              if (overtimeShifts.length > 1) {
                cellContent += `(${overtimeShifts.length})`;
              }
            }

            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            html += `<td onclick="openShiftSymbolSelector('${escapeHtml(name)}', '${dateStr}', 'overtime', ${day}, '${currentSymbol}')" style="border: 1px solid #ccc; padding: 4px; text-align: center; background-color: #fafafa; cursor: pointer; ${isWeekend ? 'background-color: #fff5f5;' : ''} min-height: 30px;" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨˜å·ã‚’é¸æŠ">${cellContent || '&nbsp;'}</td>`;
          }

          html += '<td style="border: 1px solid #ccc; padding: 6px; text-align: center; background-color: #e8f4f8;"></td>';
          html += '</tr>';
        }
      });

      html += '</table></div>';
      list.innerHTML = html;
    }

    // è¨˜å·é¸æŠãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
    function openShiftSymbolSelector(name, date, type, day, currentSymbol) {
      const symbols = [
        { value: 'ã€‡', label: 'ã€‡ï¼ˆå‡ºå‹¤ï¼‰' },
        { value: 'X', label: 'Xï¼ˆä¼‘ã¿ï¼‰' },
        { value: 'å—', label: 'å—ï¼ˆå—ä»˜ï¼‰' },
        { value: '1', label: '1' },
        { value: '2', label: '2' },
        { value: '3', label: '3' },
        { value: 'H', label: 'Hï¼ˆæ®‹æ¥­ï¼‰', onlyOvertime: true }
      ];

      // é€šå¸¸ã‚·ãƒ•ãƒˆè¡Œã®å ´åˆã¯Hã‚’é™¤å¤–
      const availableSymbols = type === 'normal'
        ? symbols.filter(s => !s.onlyOvertime)
        : symbols;

      let optionsHtml = availableSymbols.map(s => {
        const selected = currentSymbol === s.value ? 'âœ“' : '';
        return `<div onclick="selectShiftSymbol('${escapeHtml(name)}', '${date}', '${type}', ${day}, '${s.value}')" style="padding: 10px; cursor: pointer; border: 1px solid #ddd; margin: 2px; border-radius: 4px; display: inline-block; min-width: 60px; text-align: center; ${selected ? 'background-color: #e3f2fd; font-weight: bold;' : ''}" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='${selected ? '#e3f2fd' : 'white'}'">${s.value} ${selected}</div>`;
      }).join('');

      optionsHtml += `<div onclick="selectShiftSymbol('${escapeHtml(name)}', '${date}', '${type}', ${day}, '')" style="padding: 10px; cursor: pointer; border: 1px solid #ddd; margin: 2px; border-radius: 4px; display: inline-block; min-width: 60px; text-align: center; ${!currentSymbol ? 'background-color: #e3f2fd; font-weight: bold;' : ''}" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='${!currentSymbol ? '#e3f2fd' : 'white'}'">å‰Šé™¤</div>`;

      const popup = document.createElement('div');
      popup.id = 'shift-symbol-popup';
      popup.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border: 2px solid #007bff; border-radius: 8px; padding: 20px; z-index: 10000; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 500px;';
      popup.innerHTML = `
        <h3 style="margin-top: 0;">è¨˜å·ã‚’é¸æŠ</h3>
        <p style="margin-bottom: 15px; color: #666;">${escapeHtml(name)} - ${date}</p>
        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px;">
          ${optionsHtml}
        </div>
        <button onclick="closeShiftSymbolPopup()" class="btn btn-secondary" style="width: 100%;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      `;

      const overlay = document.createElement('div');
      overlay.id = 'shift-symbol-overlay';
      overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;';
      overlay.onclick = closeShiftSymbolPopup;

      document.body.appendChild(overlay);
      document.body.appendChild(popup);
    }

    function closeShiftSymbolPopup() {
      const popup = document.getElementById('shift-symbol-popup');
      const overlay = document.getElementById('shift-symbol-overlay');
      if (popup) popup.remove();
      if (overlay) overlay.remove();
    }

    async function selectShiftSymbol(name, date, type, day, symbol) {
      closeShiftSymbolPopup();

      const shifts = await apiGet('shifts.php');
      const monthInput = document.getElementById("shift-display-month");
      const [year, month] = monthInput.value.split('-').map(Number);

      // æ—¢å­˜ã®ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ï¼ˆåŒã˜æ—¥ä»˜ã€åå‰ã€ã‚¿ã‚¤ãƒ—ã®ã‚‚ã®ï¼‰
      const filteredShifts = shifts.filter(shift => {
        const shiftDate = new Date(shift.date);
        const shiftDay = shiftDate.getDate();
        const shiftYear = shiftDate.getFullYear();
        const shiftMonth = shiftDate.getMonth() + 1;

        if (shift.name !== name || shiftYear !== year || shiftMonth !== month || shiftDay !== day) {
          return true;
        }

        // ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        if (type === 'normal') {
          return shift.symbol === 'H' || shift.role === 'Hæ®‹æ¥­';
        } else {
          return shift.symbol !== 'H' && shift.role !== 'Hæ®‹æ¥­';
        }
      });

      // æ–°ã—ã„ã‚·ãƒ•ãƒˆã‚’è¿½åŠ ï¼ˆè¨˜å·ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
      if (symbol) {
        const newShift = {
          id: Date.now(),
          date: date,
          name: name,
          startTime: '09:00',
          endTime: '18:00',
          symbol: symbol,
          role: symbol === 'H' ? 'Hæ®‹æ¥­' : (symbol === 'å—' ? 'å—ä»˜' : '')
        };
        filteredShifts.push(newShift);
      }

      await apiPost('shifts.php', filteredShifts);
      loadShifts();
    }

    async function deleteAllShiftsForEmployee(name, year, month) {
      if (!confirm(`ã€Œ${name}ã€ã•ã‚“ã®${year}å¹´${month}æœˆã®ã‚·ãƒ•ãƒˆã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

      const shifts = await apiGet('shifts.php');
      const filtered = shifts.filter(shift => {
        const shiftDate = new Date(shift.date);
        return !(shift.name === name && shiftDate.getFullYear() === year && shiftDate.getMonth() + 1 === month);
      });

      await apiPost('shifts.php', filtered);
      loadShifts();
    }

    async function deleteShift(shiftId) {
      if (!confirm('ã“ã®ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      const shifts = await apiGet('shifts.php');
      const filtered = shifts.filter(s => s.id !== shiftId);
      await apiPost('shifts.php', filtered);
      loadShifts();
    }

    // === AIã‚¢ãƒ‰ãƒã‚¤ã‚¹æ©Ÿèƒ½ ===
    async function uploadExcelFile() {
      const fileInput = document.getElementById('excel-file');
      const file = fileInput.files[0];

      if (!file) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const statusDiv = document.getElementById('excel-upload-status');
      statusDiv.innerHTML = '<p style="color: #666;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</p>';

      try {
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆCSVå½¢å¼ã¨ã—ã¦æ‰±ã†ï¼‰
        const reader = new FileReader();
        reader.onload = async function (e) {
          try {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim());

            // CSVãƒ‡ãƒ¼ã‚¿ã‚’è§£æï¼ˆã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆè¨ˆã€è¡Œã‹ã‚‰æ¥å®¢æ•°ã‚’æŠ½å‡ºã€æ›œæ—¥æƒ…å ±ã‚‚å–å¾—ï¼‰
            const attendanceData = [];
            const attendanceDataWithDays = [];
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

            // æ›œæ—¥æƒ…å ±ã‚’å–å¾—ï¼ˆ2è¡Œç›®ã«æ›œæ—¥ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ï¼‰
            let dayRowIndex = -1;
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i];
              const columns = line.split(',');
              // 2åˆ—ç›®ãŒç©ºã§ã€3åˆ—ç›®ä»¥é™ã«æ›œæ—¥ãŒã‚ã‚‹è¡Œã‚’æ¢ã™
              if (columns.length > 2 && columns[0].trim() === '' && columns[1].trim() === '' && dayNames.includes(columns[2].trim())) {
                dayRowIndex = i;
                break;
              }
            }

            for (let i = 0; i < lines.length; i++) {
              const line = lines[i];
              const columns = line.split(',');

              // ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆè¨ˆã€è¡Œã‚’æ¢ã™
              if (columns.length > 1 && columns[1].trim() === 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆè¨ˆ') {
                // æ›œæ—¥æƒ…å ±ã‚’å–å¾—ï¼ˆåŒã˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ›œæ—¥è¡Œã‹ã‚‰ï¼‰
                let sectionDayRow = null;
                // ã“ã®ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆè¨ˆã€è¡Œã‚ˆã‚Šå‰ã®æ›œæ—¥è¡Œã‚’æ¢ã™
                for (let k = Math.max(0, i - 30); k < i; k++) {
                  const checkLine = lines[k];
                  const checkColumns = checkLine.split(',');
                  if (checkColumns.length > 2 && checkColumns[0].trim() === '' && checkColumns[1].trim() === '' && dayNames.includes(checkColumns[2].trim())) {
                    sectionDayRow = checkColumns;
                    break;
                  }
                }

                // 3åˆ—ç›®ä»¥é™ã‹ã‚‰æ•°å€¤ã‚’æŠ½å‡ºï¼ˆæ—¥ä»˜åˆ—ã¨ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆè¨ˆã€åˆ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
                for (let j = 2; j < columns.length; j++) {
                  const value = columns[j].trim();

                  // æ•°å€¤ã¾ãŸã¯ã€Œâœ•ã€ä»¥å¤–ã®ç©ºã§ãªã„å€¤ã‚’ãƒã‚§ãƒƒã‚¯
                  // 0ã‚‚æœ‰åŠ¹ãªæ¥å®¢æ•°ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã†ï¼ˆå–¶æ¥­ã—ã¦ã„ãªã„æ—¥ãªã©ï¼‰
                  if (value && value !== 'âœ•' && value !== '') {
                    const num = parseInt(value);
                    if (!isNaN(num) && num >= 0) {
                      attendanceData.push(num);

                      // æ›œæ—¥æƒ…å ±ã‚‚ä¿å­˜
                      let day = null;
                      if (sectionDayRow && j < sectionDayRow.length) {
                        const dayValue = sectionDayRow[j].trim();
                        if (dayNames.includes(dayValue)) {
                          day = dayValue;
                        }
                      }

                      attendanceDataWithDays.push({
                        attendance: num,
                        day: day
                      });
                    }
                  }
                }
              }
            }

            if (attendanceData.length === 0) {
              throw new Error('ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆè¨ˆã€è¡Œã‹ã‚‰æœ‰åŠ¹ãªæ¥å®¢æ•°ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }

            // JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ï¼ˆæ›œæ—¥æƒ…å ±ã‚‚å«ã‚€ï¼‰
            const data = {
              attendance: attendanceData,
              attendanceWithDays: attendanceDataWithDays,
              uploaded_at: new Date().toISOString(),
              total_records: attendanceData.length
            };

            // ãƒ‡ãƒ¼ã‚¿ã‚’APIçµŒç”±ã§ä¿å­˜ï¼ˆç°¡æ˜“ç‰ˆï¼šç›´æ¥fetchã§ä¿å­˜ï¼‰
            const response = await fetch('api/attendance-data.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });

            if (!response.ok) {
              throw new Error('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            statusDiv.innerHTML = `<p style="color: #28a745;">âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼${attendanceData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚</p>`;
            loadAttendanceData();
          } catch (error) {
            console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            statusDiv.innerHTML = `<p style="color: #dc3545;">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
          }
        };
        reader.readAsText(file);
      } catch (error) {
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        statusDiv.innerHTML = `<p style="color: #dc3545;">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
      }
    }

    async function loadAttendanceData() {
      try {
        const response = await fetch('api/attendance-data.php');
        if (!response.ok) {
          throw new Error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        const data = await response.json();
        const displayDiv = document.getElementById('attendance-data-display');

        if (data.attendance && data.attendance.length > 0) {
          const avg = Math.round(data.attendance.reduce((a, b) => a + b, 0) / data.attendance.length);
          const max = Math.max(...data.attendance);
          const min = Math.min(...data.attendance);

          displayDiv.innerHTML = `
            <div style="padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
              <p><strong>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:</strong> ${data.attendance.length}ä»¶</p>
              <p><strong>ğŸ“ˆ å¹³å‡æ¥å®¢æ•°:</strong> ${avg}äºº</p>
              <p><strong>ğŸ“Š æœ€å¤§æ¥å®¢æ•°:</strong> ${max}äºº</p>
              <p><strong>ğŸ“‰ æœ€å°æ¥å®¢æ•°:</strong> ${min}äºº</p>
              ${data.uploaded_at ? `<p><strong>ğŸ“… æœ€çµ‚æ›´æ–°:</strong> ${new Date(data.uploaded_at).toLocaleString('ja-JP')}</p>` : ''}
            </div>
          `;
        } else {
          displayDiv.innerHTML = '<p style="color: #666;">æ¥å®¢æ•°ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
        }
      } catch (error) {
        console.error('æ¥å®¢æ•°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('attendance-data-display').innerHTML =
          '<p style="color: red;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
      }
    }

    let currentMenuAdvice = null;
    let menuChatHistory = [];

    async function getMenuAdvice() {
      const displayDiv = document.getElementById('menu-advice-display');
      const chatDiv = document.getElementById('menu-advice-chat');
      displayDiv.innerHTML = '<p style="color: #666;">ğŸ¤– AIãŒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ææ¡ˆã—ã¦ã„ã¾ã™...</p>';

      try {
        const response = await fetch('api/ai-advice.php?action=menu');
        if (!response.ok) {
          throw new Error('APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        const data = await response.json();

        if (data.error) {
          displayDiv.innerHTML = `<p style="color: #dc3545;">âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}</p>`;
          return;
        }

        // ç¾åœ¨ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆã‚’ä¿å­˜
        currentMenuAdvice = data.advice;
        menuChatHistory = [];

        // æ”¹è¡Œã‚’ä¿æŒã—ã¦è¡¨ç¤ºã—ã€ä½œã‚Šæ–¹ã‚’å¼·èª¿
        let adviceText = data.advice;

        // ã€ä½œã‚Šæ–¹ã€‘ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚„ã™ãã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
        adviceText = adviceText.replace(/\nã€ä½œã‚Šæ–¹ã€‘/g, '\n\n<strong style="color: #667eea; font-size: 1.1em;">ğŸ“ ã€ä½œã‚Šæ–¹ã€‘</strong>');
        adviceText = adviceText.replace(/\n(\d+)\./g, '\n<span style="color: #495057; font-weight: bold;">$1.</span>');

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã‚’å¼·èª¿
        adviceText = adviceText.replace(/\n(ã©ã‚“ã¶ã‚Š|ä¸»èœ|å‰¯èœ|å‘³å™Œæ±)ï¼š([^\n]+)/g, '\n<strong style="color: #28a745; font-size: 1.05em;">$1ï¼š</strong>$2');

        // äºˆç®—ã‚’å¼·èª¿
        adviceText = adviceText.replace(/äºˆç®—ï¼š([^\n]+)/g, '<strong style="color: #dc3545;">ğŸ’° äºˆç®—ï¼š</strong>$1');

        // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
        adviceText = adviceText.replace(/\n/g, '<br>');

        displayDiv.innerHTML = `
          <div style="line-height: 1.8; padding: 15px; background-color: #ffffff; border-radius: 8px; border: 1px solid #e9ecef;">
            <div style="white-space: pre-wrap;">
              ${adviceText}
            </div>
          </div>
        `;

        // ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’è¡¨ç¤º
        chatDiv.style.display = 'block';
        document.getElementById('menu-chat-messages').innerHTML = '';
      } catch (error) {
        console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆã‚¨ãƒ©ãƒ¼:', error);
        displayDiv.innerHTML = `<p style="color: #dc3545;">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
      }
    }

    async function sendMenuChatMessage() {
      if (!currentMenuAdvice) {
        alert('ã¾ãšãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆã‚’å–å¾—ã—ã¦ãã ã•ã„');
        return;
      }

      const input = document.getElementById('menu-chat-input');
      const message = input.value.trim();
      if (!message) return;

      const chatMessages = document.getElementById('menu-chat-messages');

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      chatMessages.innerHTML += `
        <div style="margin-bottom: 10px; text-align: right;">
          <div style="display: inline-block; padding: 8px 12px; background-color: #667eea; color: white; border-radius: 12px; max-width: 70%;">
            ${message}
          </div>
        </div>
      `;

      input.value = '';
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
      menuChatHistory.push({ role: 'user', content: message });

      // AIå¿œç­”ã‚’å–å¾—
      try {
        // ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å«ã‚€æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
        const systemMessage = `ã‚ãªãŸã¯å­¦æ ¡é£Ÿå ‚ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆã«ã¤ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«è©³ã—ãã€ã‚ã‹ã‚Šã‚„ã™ãç­”ãˆã¦ãã ã•ã„ã€‚\n\nã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ææ¡ˆã€‘\n${currentMenuAdvice}\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã—ã¦ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä½œã‚Šæ–¹ã€ææ–™ã€èª¿ç†ã®ã‚³ãƒ„ã€æ „é¤Šä¾¡ã€äºˆç®—å†…ã§ã®èª¿æ•´æ–¹æ³•ãªã©ã€å…·ä½“çš„ã§å®Ÿç”¨çš„ãªæƒ…å ±ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚`;

        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æ§‹ç¯‰ï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æœ€åˆã«è¿½åŠ ï¼‰
        const historyForAPI = menuChatHistory.slice(-6).map(msg => ({
          role: msg.role,
          content: msg.content
        }));

        // æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å«ã‚ã‚‹
        if (historyForAPI.length === 0 || historyForAPI[0].role !== 'system') {
          historyForAPI.unshift({ role: 'system', content: systemMessage });
        } else {
          historyForAPI[0].content = systemMessage;
        }

        const response = await fetch('api/ai-response.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: message,
            history: historyForAPI,
            useOllama: true
          })
        });

        if (!response.ok) {
          throw new Error('APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const data = await response.json();

        if (data.response) {
          // AIå¿œç­”ã‚’è¡¨ç¤º
          chatMessages.innerHTML += `
            <div style="margin-bottom: 10px;">
              <div style="display: inline-block; padding: 8px 12px; background-color: #f0f0f0; color: #333; border-radius: 12px; max-width: 70%;">
                ${data.response.replace(/\n/g, '<br>')}
              </div>
            </div>
          `;

          // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
          menuChatHistory.push({ role: 'assistant', content: data.response });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        } else {
          throw new Error('AIå¿œç­”ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        }
      } catch (error) {
        console.error('ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
        chatMessages.innerHTML += `
          <div style="margin-bottom: 10px;">
            <div style="display: inline-block; padding: 8px 12px; background-color: #f8d7da; color: #721c24; border-radius: 12px; max-width: 70%;">
              âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}
            </div>
          </div>
        `;
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    }

    // Enterã‚­ãƒ¼ã§é€ä¿¡
    document.addEventListener('DOMContentLoaded', function () {
      const menuChatInput = document.getElementById('menu-chat-input');
      if (menuChatInput) {
        menuChatInput.addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
            sendMenuChatMessage();
          }
        });
      }
    });

    async function getAttendancePrediction() {
      const displayDiv = document.getElementById('attendance-prediction-display');
      displayDiv.innerHTML = '<p style="color: #666;">ğŸ¤– AIãŒæ¥å®¢æ•°ã‚’äºˆæ¸¬ã—ã¦ã„ã¾ã™...</p>';

      try {
        const response = await fetch('api/ai-advice.php?action=attendance');
        if (!response.ok) {
          throw new Error('APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        const data = await response.json();

        if (data.error) {
          displayDiv.innerHTML = `<p style="color: #dc3545;">âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}</p>`;
          return;
        }

        // äºˆæ¸¬çµæœã‚’è¡¨ç¤º
        let predictionText = '';
        if (typeof data.prediction === 'string') {
          predictionText = data.prediction.replace(/\n/g, '<br>');
        } else {
          predictionText = `äºˆæ¸¬æ¥å®¢æ•°: ç´„${data.prediction}äºº<br>${data.details || ''}`;
        }

        displayDiv.innerHTML = `
          <div style="white-space: pre-wrap; line-height: 1.8;">
            ${predictionText}
          </div>
        `;
      } catch (error) {
        console.error('æ¥å®¢æ•°äºˆæ¸¬ã‚¨ãƒ©ãƒ¼:', error);
        displayDiv.innerHTML = `<p style="color: #dc3545;">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
      }
    }

    // === èµ·å‹•æ™‚ ===
    function renderLinks() {
      const base = window.location.href.replace(/[^/]*$/, '');
      const pages = [
        { name: 'ç”Ÿå¾’ç”¨ã‚µã‚¤ãƒˆ (index.html)', file: 'index.html' },
        { name: 'ç®¡ç†è€…ã‚µã‚¤ãƒˆ (admin.html)', file: 'admin.html' },
        { name: 'äºˆç´„ã‚µã‚¤ãƒˆ (book.html)', file: 'book.html' },
        { name: 'äºˆç´„ç¢ºèªã‚·ã‚¹ãƒ†ãƒ  (verification.html)', file: 'verification.html' },
        { name: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ (review.html)', file: 'review.html' },
        { name: 'é£Ÿå ‚å°‚ç”¨AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ (ai-assistant-php.html)', file: 'ai-assistant-php.html' }
      ];
      const linksDiv = document.getElementById('page-links');
      if (!linksDiv) return;
      linksDiv.innerHTML = pages.map(p => {
        const url = base + p.file;
        return `<p><strong>${p.name}:</strong> <a href="${url}">${url}</a></p>`;
      }).join('');
    }

    // èƒŒæ™¯ç”»åƒã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–
    document.addEventListener('DOMContentLoaded', function () {
      const pageBg = document.querySelector('.page-bg');
      if (pageBg) {
        const timestamp = new Date().getTime();
        pageBg.style.backgroundImage = `url('images/olive.jpg?v=${timestamp}')`;
      }
    });

    window.onload = function () {
      // äºˆç´„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã€Œã™ã¹ã¦ã€è¡¨ç¤ºï¼‰
      const dateEl = document.getElementById('admin-filter-date');
      if (dateEl && !dateEl.value) dateEl.value = getTodayIso();
      const modeEl = document.getElementById('admin-filter-mode');
      if (modeEl && !modeEl.value) modeEl.value = 'all'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ã€Œã™ã¹ã¦ã€ã«è¨­å®š
      const qEl = document.getElementById('admin-filter-q');
      const reloadReservations = () => loadReservations();
      if (dateEl) dateEl.addEventListener('change', reloadReservations);
      if (modeEl) modeEl.addEventListener('change', reloadReservations);
      if (qEl) qEl.addEventListener('input', reloadReservations);

      // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      loadMenus();
      loadHolidays();
      loadDailyMenus();
      loadEvents();
      loadReservations();
      loadReviews();
      loadReservationTimes();
      loadShifts();
      loadAttendanceData();
      renderCalendar();
      renderLinks();

      // ç¾åœ¨ã®æœˆã‚’é¸æŠ
      const currentMonth = new Date().getMonth() + 1;
      document.getElementById('report-month').value = currentMonth;
      document.getElementById('ai-analysis-month').value = currentMonth;

      // äºˆç´„ä¸€è¦§ã‚’30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
      setInterval(() => {
        loadReservations();
      }, 30000); // 30ç§’

      // ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ã‚’60ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
      setInterval(() => {
        loadReviews();
      }, 60000); // 60ç§’
    };
  </script>
</body>

</html>