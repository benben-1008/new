<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿå ‚å°‚ç”¨AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .page-bg {
            position: relative;
            background-color: #f5f5f5;
        }

        .page-bg::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('images/olive.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            opacity: 0.2;
            z-index: 1;
            pointer-events: none;
        }

        .page-bg-image-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            opacity: 0.2;
            z-index: 1;
            pointer-events: none;
        }

        .page-bg>* {
            position: relative;
            z-index: 2;
        }

        .container {
            background-color: rgba(255, 255, 255, 0.98);
            max-width: 920px;
            margin: 0 auto;
            padding: 28px;
            box-shadow: 0 8px 40px rgba(107, 124, 58, 0.12);
            border-radius: 28px;
        }

        /* ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠï¼šã‚„ã•ã—ã„é›°å›²æ°—ã§è¦‹ã‚„ã™ã */
        .chat-container {
            background: #fafbfc;
            border-radius: 24px;
            box-shadow: 0 4px 24px rgba(107, 124, 58, 0.08);
            overflow: hidden;
            margin-bottom: 28px;
            border: 2px solid #e8ebe6;
        }

        /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ï¼šä¸€ç•ªä¸Šã¾ã§ç¢ºå®Ÿã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã« */
        .chat-messages {
            height: 520px;
            min-height: 320px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0;
            background: linear-gradient(to bottom, #f0f4f8 0%, #ffffff 100%);
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            display: block;
        }

        .chat-messages-inner {
            padding: 20px 20px 24px;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-messages-inner .message {
            margin-bottom: 0;
        }

        .chat-messages::-webkit-scrollbar {
            width: 10px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’å°‘ã—å¤ªãã—ã¦è¦‹ã‚„ã™ã */
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
            margin: 5px 0; /* ä¸Šä¸‹ã«ä½™ç™½ã‚’è¿½åŠ  */
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #8B9A46;
            border-radius: 6px;
            border: 2px solid #f1f1f1;
            min-height: 36px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #6B7C3A;
        }

        /* Firefoxç”¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
        .chat-messages {
            scrollbar-width: thin;
            scrollbar-color: #8B9A46 #e8ebe6;
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‡ã‚¶ã‚¤ãƒ³æ”¹å–„ */
        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
            display: flex;
            align-items: flex-start;
            width: 100%;
            min-height: auto;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            flex-direction: row-reverse;
        }

        .message .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .assistant-message .avatar,
        .assistant-message-avatar {
            background: linear-gradient(135deg, #8B9A46 0%, #6B7C3A 100%);
            color: white;
            background-image: url('images/olive.jpg');
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .assistant-message .avatar::before,
        .assistant-message-avatar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(139, 154, 70, 0.5);
            border-radius: 50%;
            z-index: 1;
        }

        .assistant-message .avatar>span,
        .assistant-message-avatar>span {
            position: relative;
            z-index: 2;
        }

        .user-message .avatar {
            background: linear-gradient(135deg, #6B7C3A 0%, #8B9A46 100%);
            color: white;
        }

        .message .content {
            max-width: 75%;
            margin: 0 12px;
            min-width: 200px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: visible;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #5c6348;
            font-weight: 600;
        }

        .message-time {
            margin-left: auto;
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .message-content {
            padding: 14px 18px;
            border-radius: 20px;
            line-height: 1.75;
            font-size: 1.02rem;
            word-wrap: break-word;
            word-break: break-word;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            white-space: pre-wrap;
            overflow: visible;
            overflow-wrap: break-word;
            min-height: auto;
            width: 100%;
            max-width: 100%;
            display: block;
            box-sizing: border-box;
        }

        .assistant-message .message-content {
            background: white;
            color: #2d3436;
            border: 1px solid #e8ebe6;
            border-top-left-radius: 6px;
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #6B7C3A 0%, #8B9A46 100%);
            color: white;
            border-top-right-radius: 6px;
        }

        /* ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ï¼šæŠ¼ã—ã‚„ã™ãè¦‹ã‚„ã™ã„ */
        .chat-input-container {
            display: flex;
            gap: 14px;
            padding: 20px 22px;
            background: linear-gradient(to bottom, #ffffff 0%, #f6f8f2 100%);
            border-top: 2px solid #e8ebe6;
        }

        #chatInput {
            flex: 1;
            padding: 16px 22px;
            border: 2px solid #e0e4dc;
            border-radius: 28px;
            font-size: 1.06rem;
            transition: all 0.25s ease;
            background: #fff;
            color: #2d3436;
        }

        #chatInput::placeholder {
            color: #7d8b6e;
            opacity: 0.85;
        }

        #chatInput:focus {
            outline: none;
            border-color: #8B9A46;
            background: #fff;
            box-shadow: 0 0 0 4px rgba(139, 154, 70, 0.18);
            transform: translateY(-1px);
        }

        #sendBtn {
            padding: 16px 28px;
            background: linear-gradient(135deg, #6B7C3A 0%, #8B9A46 100%);
            color: white;
            border: none;
            border-radius: 28px;
            font-size: 1.06rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 4px 16px rgba(107, 124, 58, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
        }

        #sendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 124, 58, 0.45);
            background: linear-gradient(135deg, #5a6a30 0%, #7a8a3e 100%);
        }

        #sendBtn:active {
            transform: translateY(0);
            box-shadow: 0 2px 12px rgba(107, 124, 58, 0.3);
        }

        #sendBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* ã‚¯ã‚¤ãƒƒã‚¯è³ªå•ï¼šæŠ¼ã—ã‚„ã™ãè¦‹ã‚„ã™ã„ */
        .quick-questions {
            margin-top: 28px;
            padding: 24px;
            background: linear-gradient(135deg, #f6f8f2 0%, #ffffff 100%);
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(107, 124, 58, 0.06);
            border: 2px solid #e8ebe6;
        }

        .quick-questions h3 {
            margin: 0 0 18px 0;
            color: #3d4629;
            font-size: 1.35rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 14px;
            border-bottom: 2px solid #e0e4dc;
        }

        .quick-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px;
            margin-bottom: 18px;
        }

        .quick-btn {
            padding: 16px 18px;
            background: white;
            border: 2px solid #e0e4dc;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-size: 1rem;
            font-weight: 600;
            color: #4a5535;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
            position: relative;
            overflow: hidden;
        }

        .quick-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #6B7C3A 0%, #8B9A46 100%);
            transition: left 0.28s ease;
            z-index: 0;
        }

        .quick-btn span {
            position: relative;
            z-index: 1;
        }

        .quick-btn:hover {
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(107, 124, 58, 0.3);
        }

        .quick-btn:hover::before {
            left: 0;
        }

        .quick-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(107, 124, 58, 0.2);
        }

        /* AIè¨­å®šï¼šè¦‹ã‚„ã™ã */
        .ai-settings {
            margin-top: 22px;
            padding: 22px;
            background: linear-gradient(135deg, #f6f8f2 0%, #ffffff 100%);
            border-radius: 18px;
            border: 2px solid #e8ebe6;
            box-shadow: 0 2px 12px rgba(107, 124, 58, 0.05);
        }

        .ai-settings h4 {
            margin: 0 0 16px 0;
            color: #3d4629;
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-settings label {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1.02rem;
            color: #4a5535;
            padding: 10px 12px;
            border-radius: 12px;
            transition: background-color 0.2s ease;
        }

        .ai-settings label:hover {
            background-color: rgba(139, 154, 70, 0.08);
        }

        .ai-settings input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #8B9A46;
        }

        .status-indicator {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .status-indicator.available {
            background: linear-gradient(135deg, #e8f0e0 0%, #d4e6c8 100%);
            color: #2d5a1c;
            border: 2px solid #8B9A46;
        }

        .status-indicator.unavailable {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 2px solid #dc3545;
        }

        /* ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .debug-info {
            margin-top: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .debug-info.gemini {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
        }

        .debug-info.groq {
            background: linear-gradient(135deg, #00d4ff 0%, #090979 100%);
        }

        .debug-info.openai {
            background: linear-gradient(135deg, #10a37f 0%, #1a7f64 100%);
        }

        .debug-info.huggingface {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
        }

        .debug-info.ollama {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        }

        .debug-info-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .debug-info-detail {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .api-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.3);
            margin-left: 8px;
        }

        /* è¿½åŠ : ã‚¢ãƒã‚¿ãƒ¼ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .message {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .message .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: #f0f0f0;
            flex-shrink: 0;
            border: 1px solid #e0e0e0;
        }

        .message .content {
            flex: 1;
        }

        .assistant-message .avatar {
            background: #e8f5e9;
            border-color: #c8e6c9;
        }

        .user-message .avatar {
            background: #eef2f7;
            border-color: #d5deea;
        }

        /* ãƒ’ãƒ¼ãƒ­ãƒ¼ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« */
        .ai-hero {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 18px;
            margin-top: 15px;
        }

        /* é‹å–¶æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ”¹å–„ */
        .info-section {
            margin-top: 35px;
        }

        .info-section h2 {
            font-size: 1.5rem;
            color: #3d4629;
            margin-bottom: 18px;
            padding-left: 14px;
            border-left: 5px solid #8B9A46;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-card {
            background: linear-gradient(135deg, #ffffff 0%, #f6f8f2 100%);
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 4px 18px rgba(107, 124, 58, 0.08);
            line-height: 1.85;
            border: 2px solid #e8ebe6;
            font-size: 1.02rem;
            color: #2d3436;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                border-radius: 20px;
            }

            header h1 {
                font-size: 1.6rem;
            }

            .chat-messages {
                height: 420px;
                min-height: 280px;
                overflow-y: auto;
            }

            .chat-messages-inner {
                padding: 16px;
            }

            .message .content {
                max-width: 85%;
            }

            .quick-buttons {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .quick-btn {
                padding: 14px 18px;
                font-size: 0.95rem;
            }

            .chat-input-container {
                flex-direction: column;
                padding: 16px;
                gap: 12px;
            }

            #chatInput {
                padding: 14px 20px;
                font-size: 1rem;
            }

            #sendBtn {
                width: 100%;
                padding: 14px 24px;
            }

            .quick-questions {
                padding: 20px;
            }

            .ai-settings {
                padding: 20px;
            }

            .info-card {
                padding: 20px;
            }
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
            padding: 12px 16px;
            background: #e9ecef;
            border-radius: 18px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #8B9A46;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.7;
            }

            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="page-bg">
    <div class="page-bg-image-overlay" id="bgImageOverlay"></div>
    <div class="container">
        <header
            style="text-align: center; margin-bottom: 28px; padding: 32px 24px 28px; background: linear-gradient(135deg, #6B7C3A 0%, #8B9A46 50%, #7a8a3e 100%); border-radius: 24px; color: white; box-shadow: 0 6px 28px rgba(107, 124, 58, 0.35); position: relative; overflow: hidden;">
            <div style="position: absolute; top: -40px; right: -40px; width: 160px; height: 160px; background: rgba(255, 255, 255, 0.12); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -20px; left: -20px; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.08); border-radius: 50%;"></div>
            <div style="position: relative; z-index: 1;">
                <div class="header-olive-icon" style="width: 72px; height: 72px; margin: 0 auto 14px; border-radius: 50%; background-image: url('images/olive.jpg'); background-size: cover; background-position: center; box-shadow: 0 4px 16px rgba(0,0,0,0.2); border: 3px solid rgba(255,255,255,0.9);"></div>
                <h1 style="font-size: 1.95rem; margin: 0 0 10px 0; color: white; text-shadow: 0 2px 8px rgba(0,0,0,0.2); font-weight: 700; letter-spacing: 0.02em;">
                    é£Ÿå ‚å°‚ç”¨AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h1>
                <p style="font-size: 1.08rem; margin: 0; color: rgba(255,255,255,0.95); font-weight: 500; line-height: 1.65;">
                    ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»å–¶æ¥­æ™‚é–“ãƒ»äºˆç´„ã«ã¤ã„ã¦ã€ä½•ã§ã‚‚ãŠæ°—è»½ã«ã©ã†ã</p>
                <p style="font-size: 0.85rem; margin: 12px 0 0; color: rgba(255,255,255,0.8);">â€» ä¼šè©±ã¯ä¸Šã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã”è¦§ã„ãŸã ã‘ã¾ã™</p>
            </div>
        </header>

        <div class="chat-container">
            <div id="chatMessages" class="chat-messages">
                <div id="chatMessagesInner" class="chat-messages-inner"></div>
            </div>

            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="ğŸ’­ è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šä»Šæ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ï¼Ÿå–¶æ¥­æ™‚é–“ã‚’æ•™ãˆã¦ï¼‰" maxlength="500">
                <button id="sendBtn">
                    <span style="margin-right: 5px;">ğŸ“¤</span>
                    é€ä¿¡
                </button>
            </div>
        </div>

        <div class="quick-questions">
            <h3>ğŸ’¡ ã‚ˆãã‚ã‚‹è³ªå•ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è³ªå•ï¼‰</h3>
            <div class="quick-buttons">
                <button class="quick-btn" data-question="ä»Šæ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ä½•ã§ã™ã‹ï¼Ÿ"><span>ğŸ“‹ ä»Šæ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span></button>
                <button class="quick-btn" data-question="å–¶æ¥­æ™‚é–“ã‚’æ•™ãˆã¦ãã ã•ã„"><span>â° å–¶æ¥­æ™‚é–“</span></button>
                <button class="quick-btn" data-question="äºˆç´„ã¯ã§ãã¾ã™ã‹ï¼Ÿ"><span>ğŸ“ äºˆç´„ã«ã¤ã„ã¦</span></button>
                <button class="quick-btn" data-question="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼å¯¾å¿œã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"><span>âš ï¸ ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼å¯¾å¿œ</span></button>
                <button class="quick-btn" data-question="ãƒ‘ãƒ³ã‹é£Ÿå ‚ã‹ã©ã£ã¡ãŒãŠã™ã™ã‚ï¼Ÿ"><span>ğŸ ãƒ‘ãƒ³/é£Ÿå ‚</span></button>
                <button class="quick-btn" data-question="ä»Šæ—¥ã¯æ··é›‘ã—ãã†ã§ã™ã‹ï¼Ÿ"><span>ğŸ‘¥ æ··é›‘äºˆæ¸¬</span></button>
            </div>
        </div>

        <section class="info-section">
            <h2>ğŸ“Š é‹å–¶æƒ…å ±</h2>
            <div id="ops-info" class="info-card"></div>
        </section>

        <div class="back-link" style="text-align: center; margin-top: 32px; padding: 24px;">
            <a href="index.html" id="backLink"
                style="display: inline-flex; align-items: center; gap: 8px; padding: 14px 26px; background: white; color: #6B7C3A; text-decoration: none; border-radius: 28px; font-weight: 700; font-size: 1.05rem; border: 2px solid #8B9A46; transition: all 0.25s ease; box-shadow: 0 4px 14px rgba(107, 124, 58, 0.18);">
                <span>â†</span>
                <span>ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</span>
            </a>
        </div>
        
        <style>
            #backLink:hover {
                background: linear-gradient(135deg, #6B7C3A 0%, #8B9A46 100%);
                color: white;
                border-color: transparent;
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(107, 124, 58, 0.35);
            }
        </style>
    </div>

    <script>
        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ä¿å­˜
        let chatHistory = [];

        // æœ¬ç•ªç’°å¢ƒã‹ã©ã†ã‹ã‚’åˆ¤å®š
        function isProductionEnvironment() {
            const host = window.location.hostname;
            const isLocalhost = host === 'localhost' ||
                host === '127.0.0.1' ||
                host === '::1' ||
                host.includes('localhost');
            return !isLocalhost;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', function () {
            console.log('AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆPHPç‰ˆï¼‰ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');

            // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–ï¼ˆä¸€ç•ªä¸Šã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.style.overflowY = 'auto';
                console.log('ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ');
            }

            // èƒŒæ™¯ç”»åƒã‚’è¨­å®šï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ï¼‰
            const bgOverlay = document.getElementById('bgImageOverlay');
            if (bgOverlay) {
                const timestamp = new Date().getTime();
                bgOverlay.style.backgroundImage = `url('images/olive.jpg?v=${timestamp}')`;
                console.log('èƒŒæ™¯ç”»åƒã‚’è¨­å®šã—ã¾ã—ãŸ:', `images/olive.jpg?v=${timestamp}`);
            }

            // å–¶æ¥­æ™‚é–“ã®è³ªå•ã‹ã‚‰ãƒãƒ£ãƒƒãƒˆã‚’ã‚¹ã‚¿ãƒ¼ãƒˆ
            runInitialQuestion();

            // é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const sendBtn = document.getElementById('sendBtn');
            console.log('é€ä¿¡ãƒœã‚¿ãƒ³è¦ç´ :', sendBtn);
            if (sendBtn) {
                sendBtn.addEventListener('click', function () {
                    console.log('é€ä¿¡ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    sendMessage();
                });
                console.log('é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
            } else {
                console.error('é€ä¿¡ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®Enterã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
            const chatInput = document.getElementById('chatInput');
            console.log('å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¦ç´ :', chatInput);
            if (chatInput) {
                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–ï¼ˆå¿µã®ãŸã‚ï¼‰
                chatInput.disabled = false;
                chatInput.readOnly = false;

                chatInput.addEventListener('keypress', function (e) {
                    console.log('ã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ:', e.key);
                    if (e.key === 'Enter') {
                        console.log('Enterã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');
                        sendMessage();
                    }
                });
                console.log('å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');

                // åˆæœŸåŒ–å¾Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
                setTimeout(() => {
                    chatInput.focus();
                }, 100);
            } else {
                console.error('å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // ã‚¯ã‚¤ãƒƒã‚¯è³ªå•ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const quickButtons = document.querySelectorAll('.quick-btn');
            console.log('ã‚¯ã‚¤ãƒƒã‚¯è³ªå•ãƒœã‚¿ãƒ³ã®æ•°:', quickButtons.length);
            quickButtons.forEach((button, index) => {
                console.log(`ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³${index + 1}:`, button);
                button.addEventListener('click', function () {
                    console.log('ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ:', this.textContent);
                    const question = this.getAttribute('data-question');
                    console.log('è³ªå•å†…å®¹:', question);
                    document.getElementById('chatInput').value = question;
                    sendMessage();
                });
            });

            // é‹å–¶æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
            loadOpsInfo();
        });

        // èµ·å‹•æ™‚ï¼šå–¶æ¥­æ™‚é–“ã®è³ªå•ã‚’é€ä¿¡ã—ã€AIã®è¿”ç­”ã‹ã‚‰ãƒãƒ£ãƒƒãƒˆã‚’ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆAPIã¯å¸¸ã«åˆ©ç”¨ï¼‰
        async function runInitialQuestion() {
            const initialQuestion = 'å–¶æ¥­æ™‚é–“ã‚’æ•™ãˆã¦ãã ã•ã„';
            const chatMessagesInner = document.getElementById('chatMessagesInner');
            const chatMessages = document.getElementById('chatMessages');
            const appendTo = chatMessagesInner || chatMessages;
            if (!appendTo || !chatMessages) return;

            addMessageToChat('user', initialQuestion);
            chatHistory.push({ sender: 'user', message: initialQuestion });

            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant-message';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="avatar assistant-message-avatar" style="background-image: url('images/olive.jpg'); background-size: cover; background-position: center; position: relative;"></div>
                <div class="content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            appendTo.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const response = await fetch('api/ai-response.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: initialQuestion,
                        history: [],
                        useOllama: true
                    })
                });
                const responseText = await response.text();
                let data = null;
                try {
                    data = response.ok ? JSON.parse(responseText) : null;
                } catch (_) {}

                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) typingIndicator.remove();

                if (data && data.response) {
                    addMessageToChat('assistant', data.response, data.debug || { usedApi: data.usedApi || data.apiType });
                    chatHistory.push({ sender: 'assistant', message: data.response });
                } else {
                    const errMsg = 'å–¶æ¥­æ™‚é–“ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                    addMessageToChat('assistant', errMsg);
                    chatHistory.push({ sender: 'assistant', message: errMsg });
                }
            } catch (err) {
                console.error('åˆæœŸè³ªå•ã‚¨ãƒ©ãƒ¼:', err);
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) typingIndicator.remove();
                const errMsg = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚';
                addMessageToChat('assistant', errMsg);
                chatHistory.push({ sender: 'assistant', message: errMsg });
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // é‹å–¶æƒ…å ±ï¼ˆå®šé£Ÿãƒ»ä¼‘æ¥­æ—¥ãƒ»äºˆç´„æ™‚é–“ãƒ»äºˆç´„äººæ•°/æ··é›‘äºˆæ¸¬ï¼‰
        async function loadOpsInfo() {
            const opsDiv = document.getElementById('ops-info');
            if (!opsDiv) return;

            const API_BASE = 'api/';
            async function apiGet(path) {
                const res = await fetch(API_BASE + path, { cache: 'no-store' });
                if (!res.ok) throw new Error('GET failed: ' + path);
                return await res.json();
            }

            try {
                const [holidays, dailyMenus, reservationTimes, reservations] = await Promise.all([
                    apiGet('holidays.php'),
                    apiGet('daily-menu.php'),
                    apiGet('reservation-times.php'),
                    fetch(API_BASE + 'sales-data.php?reservations=true', { cache: 'no-store' }).then(r => r.json())
                ]);

                const today = new Date().toISOString().split('T')[0];
                const todayMenu = (dailyMenus || []).find(m => m.date === today);
                const todayHoliday = (holidays || []).find(h => h.date === today);

                // äºˆç´„äººæ•°ï¼ˆæœ¬æ—¥ï¼‰
                const todaysReservations = (reservations || []).filter(r => (r.createdAt || '').startsWith(today));
                const reservationCount = todaysReservations.length;

                // æ¥å®¢æ•°äºˆæ¸¬ã‚’å–å¾—ï¼ˆai-advice.phpã‹ã‚‰ï¼‰
                let predictionNumber = null;
                let congestion = 'ãƒ‡ãƒ¼ã‚¿ä¸è¶³';
                let congestionColor = '#6c757d';

                try {
                    const predictionResponse = await fetch('api/ai-advice.php?action=prediction-number');
                    if (predictionResponse.ok) {
                        const predictionData = await predictionResponse.json();
                        if (predictionData.prediction !== null && predictionData.prediction !== undefined) {
                            predictionNumber = predictionData.prediction;
                            if (predictionData.congestion) {
                                congestion = predictionData.congestion.text;
                                congestionColor = predictionData.congestion.color;
                            }
                        }
                    }
                } catch (e) {
                    console.error('æ¥å®¢æ•°äºˆæ¸¬ã®å–å¾—ã«å¤±æ•—:', e);
                }

                // äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯äºˆç´„äººæ•°ãƒ™ãƒ¼ã‚¹ã®æ··é›‘äºˆæ¸¬ã‚’ä½¿ç”¨
                if (predictionNumber === null) {
                    congestion = 'ç©ºã„ã¦ã„ã¾ã™';
                    if (reservationCount >= 30) congestion = 'éå¸¸ã«æ··é›‘';
                    else if (reservationCount >= 15) congestion = 'ã‚„ã‚„æ··é›‘';
                }

                // äºˆç´„æ™‚é–“è¡¨ç¤ºï¼ˆè¤‡æ•°æ™‚é–“å¸¯å¯¾å¿œï¼‰
                let timeHtml = '';
                if (reservationTimes && reservationTimes.enabled) {
                    // å¾Œæ–¹äº’æ›æ€§: å¤ã„å½¢å¼ï¼ˆstartTime/endTimeï¼‰ã¨æ–°ã—ã„å½¢å¼ï¼ˆtimeSlotsï¼‰ã®ä¸¡æ–¹ã«å¯¾å¿œ
                    let timeSlots = [];
                    if (reservationTimes.timeSlots && Array.isArray(reservationTimes.timeSlots) && reservationTimes.timeSlots.length > 0) {
                        timeSlots = reservationTimes.timeSlots;
                    } else if (reservationTimes.startTime && reservationTimes.endTime) {
                        // å¤ã„å½¢å¼ã®å ´åˆ
                        timeSlots = [{ startTime: reservationTimes.startTime, endTime: reservationTimes.endTime }];
                    }

                    if (timeSlots.length > 0) {
                        const timeStrings = timeSlots.map(slot => `${slot.startTime} - ${slot.endTime}`).join('ã€');
                        timeHtml = `â° äºˆç´„æ™‚é–“: ${timeStrings}<br>`;
                        if (reservationTimes.message) {
                            timeHtml += `<span style="font-size: 0.9rem; color: #6c757d;">${reservationTimes.message}</span><br>`;
                        }
                    } else {
                        timeHtml = 'â° äºˆç´„æ™‚é–“: åˆ¶é™ãªã—ï¼ˆã„ã¤ã§ã‚‚äºˆç´„å¯èƒ½ï¼‰<br>';
                    }
                } else {
                    timeHtml = 'â° äºˆç´„æ™‚é–“: åˆ¶é™ãªã—ï¼ˆã„ã¤ã§ã‚‚äºˆç´„å¯èƒ½ï¼‰<br>';
                }

                opsDiv.innerHTML = `
                    <div style="line-height:1.8;">
                        <p><strong>ğŸ“… æœ¬æ—¥ã®å–¶æ¥­çŠ¶æ³:</strong> ${todayHoliday ? `ğŸš« ä¼‘æ¥­ï¼ˆç†ç”±: ${todayHoliday.reason}ï¼‰` : 'âœ… å–¶æ¥­äºˆå®š'}</p>
                        <p><strong>ğŸ½ï¸ æœ¬æ—¥ã®å®šé£Ÿ:</strong> ${todayMenu ? todayMenu.food : 'æœªè¨­å®š'}</p>
                        <p>${timeHtml}<strong>ğŸ‘¥ æœ¬æ—¥ã®äºˆç´„äººæ•°:</strong> ${reservationCount}äºº<br>
                        ${predictionNumber !== null ? `<strong>ğŸ“Š äºˆæ¸¬æ¥å®¢æ•°:</strong> ç´„${predictionNumber}äºº<br>` : ''}
                        <strong>ğŸ“ˆ æ··é›‘äºˆæ¸¬:</strong> <span style="color: ${congestionColor}; font-weight: bold;">${congestion}</span></p>
                    </div>
                `;
            } catch (e) {
                console.error('é‹å–¶æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
                opsDiv.innerHTML = '<p style="color:#dc3545;">é‹å–¶æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒƒãƒˆã«è¿½åŠ 
        function addMessageToChat(sender, message, debugInfo = null) {
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£ã—ãæ¸¡ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (!message || typeof message !== 'string') {
                console.error('addMessageToChat: ç„¡åŠ¹ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', message);
                return;
            }
            
            const chatMessages = document.getElementById('chatMessages');
            const chatMessagesInner = document.getElementById('chatMessagesInner');
            const scrollContainer = chatMessages;
            const appendTarget = chatMessagesInner || chatMessages;
            if (!appendTarget) {
                console.error('addMessageToChat: ãƒãƒ£ãƒƒãƒˆè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            const senderName = sender === 'user' ? 'ã‚ãªãŸ' : 'AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ';
            const avatarEmoji = sender === 'user' ? 'ğŸ‘¤' : '';
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒã‚ã‚‹å ´åˆã€AIåã‚’è¡¨ç¤º
            let apiNameDisplay = '';
            if (debugInfo && debugInfo.usedApi) {
                const apiNames = {
                    'gemini': 'ğŸ¤– Gemini',
                    'groq': 'âš¡ Groq',
                    'openai': 'ğŸ§  OpenAI',
                    'huggingface': 'ğŸ¤— Hugging Face',
                    'ollama': 'ğŸ¤– Ollama'
                };
                apiNameDisplay = `<span class="api-badge">${apiNames[debugInfo.usedApi] || debugInfo.usedApi}</span>`;
            }
            
            // ã‚¢ãƒã‚¿ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šï¼ˆAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®å ´åˆã€ã‚ªãƒªãƒ¼ãƒ–ç”»åƒã®ã¿ã‚’ä½¿ç”¨ï¼‰
            let avatarHtml = `<div class="avatar" aria-hidden="true">${avatarEmoji}</div>`;
            if (sender === 'assistant') {
                avatarHtml = `<div class="avatar assistant-message-avatar" aria-hidden="true" style="background-image: url('images/olive.jpg'); background-size: cover; background-position: center; position: relative;"></div>`;
            }
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å®‰å…¨ã«å‡¦ç†
            const rawMessage = String(message).trim();
            
            // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆå‡¦ç†å‰ï¼‰
            console.log('=== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†é–‹å§‹ ===');
            console.log('é€ä¿¡è€…:', sender);
            console.log('å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·:', rawMessage.length);
            console.log('å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¨æ–‡:', rawMessage);
            console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å„æ–‡å­—:', Array.from(rawMessage).slice(0, 50).map(c => `'${c}'(${c.charCodeAt(0)})`).join(' '));
            
            // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ï¼ˆ&ã‚’æœ€åˆã«å‡¦ç†ï¼‰
            let escapedMessage = rawMessage
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
            
            // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
            escapedMessage = escapedMessage.replace(/\n/g, '<br>');
            
            console.log('ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å¾Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·:', escapedMessage.length);
            console.log('ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å¾Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¨æ–‡:', escapedMessage);
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å®‰å…¨ã«ä½œæˆ
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            contentDiv.style.cssText = 'flex: 1; min-width: 0; overflow: visible;';
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            const headerStrong = document.createElement('strong');
            headerStrong.textContent = senderName;
            headerDiv.appendChild(headerStrong);
            if (apiNameDisplay) {
                const apiBadge = document.createElement('span');
                apiBadge.innerHTML = apiNameDisplay;
                headerDiv.appendChild(apiBadge);
            }
            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.textContent = new Date().toLocaleTimeString('ja-JP');
            headerDiv.appendChild(timeSpan);
            
            const messageContentDiv = document.createElement('div');
            messageContentDiv.className = 'message-content';
            messageContentDiv.style.cssText = 'display: block; width: 100%; max-width: 100%; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; overflow: visible; box-sizing: border-box;';
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç›´æ¥è¨­å®šï¼ˆinnerHTMLã‚’ä½¿ç”¨ï¼‰
            messageContentDiv.innerHTML = escapedMessage;
            
            // è¨­å®šå¾Œã«ç¢ºèª
            const setMessage = () => {
                const actualText = messageContentDiv.textContent || messageContentDiv.innerText || '';
                const actualHTML = messageContentDiv.innerHTML || '';
                console.log('=== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨­å®šç¢ºèª ===');
                console.log('è¨­å®šã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆé•·:', actualText.length);
                console.log('è¨­å®šã•ã‚ŒãŸHTMLé•·:', actualHTML.length);
                console.log('è¨­å®šã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆå…¨æ–‡:', actualText);
                console.log('è¨­å®šã•ã‚ŒãŸHTMLå…¨æ–‡:', actualHTML);
                
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸å®Œå…¨ãªå ´åˆã€å¼·åˆ¶çš„ã«å†è¨­å®š
                if (actualText.length < rawMessage.length * 0.8) {
                    console.warn('âš ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸å®Œå…¨ã§ã™ã€‚å¼·åˆ¶çš„ã«å†è¨­å®šã—ã¾ã™ã€‚');
                    messageContentDiv.innerHTML = escapedMessage;
                    // ã‚‚ã†ä¸€åº¦ç¢ºèª
                    setTimeout(() => {
                        const recheckText = messageContentDiv.textContent || messageContentDiv.innerText || '';
                        console.log('å†è¨­å®šå¾Œã®ãƒ†ã‚­ã‚¹ãƒˆé•·:', recheckText.length);
                        console.log('å†è¨­å®šå¾Œã®ãƒ†ã‚­ã‚¹ãƒˆå…¨æ–‡:', recheckText);
                    }, 50);
                }
            };
            
            // å³åº§ã«ç¢ºèª
            setTimeout(setMessage, 0);
            
            contentDiv.appendChild(headerDiv);
            contentDiv.appendChild(messageContentDiv);
            
            if (debugInfo && debugInfo.usedApi) {
                const debugDiv = document.createElement('div');
                debugDiv.innerHTML = createDebugInfoHTML(debugInfo);
                contentDiv.appendChild(debugDiv);
            }
            
            // ã‚¢ãƒã‚¿ãƒ¼ã‚’è¿½åŠ 
            const avatarElement = document.createElement('div');
            avatarElement.className = sender === 'assistant' ? 'avatar assistant-message-avatar' : 'avatar';
            avatarElement.setAttribute('aria-hidden', 'true');
            if (sender === 'assistant') {
                avatarElement.style.cssText = "background-image: url('images/olive.jpg'); background-size: cover; background-position: center; position: relative;";
            } else {
                avatarElement.textContent = avatarEmoji;
            }
            
            messageDiv.appendChild(avatarElement);
            messageDiv.appendChild(contentDiv);

            appendTarget.appendChild(messageDiv);
            
            // è¿½åŠ å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆè¤‡æ•°å›ãƒã‚§ãƒƒã‚¯ï¼‰
            const checkMessageDisplay = (attempt = 1) => {
                const addedContent = messageDiv.querySelector('.message-content');
                if (addedContent) {
                    const displayedText = addedContent.textContent || addedContent.innerText || '';
                    const displayedHTML = addedContent.innerHTML || '';
                    const originalText = String(message).trim();
                    
                    console.log(`=== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç¢ºèª (è©¦è¡Œ ${attempt}) ===`);
                    console.log('è¡¨ç¤ºã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆé•·:', displayedText.length);
                    console.log('å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·:', originalText.length);
                    console.log('è¡¨ç¤ºç‡:', ((displayedText.length / originalText.length) * 100).toFixed(1) + '%');
                    console.log('è¡¨ç¤ºã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆå…¨æ–‡:', displayedText);
                    console.log('å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¨æ–‡:', originalText);
                    console.log('è¡¨ç¤ºã•ã‚ŒãŸHTMLå…¨æ–‡:', displayedHTML);
                    
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸å®Œå…¨ãªå ´åˆã€å¼·åˆ¶çš„ã«å†è¨­å®š
                    if (displayedText.length < originalText.length * 0.8 && originalText.length > 10 && attempt <= 3) {
                        console.warn(`âš ï¸ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸å®Œå…¨ã§ã™ï¼ˆ${attempt}å›ç›®ã®è©¦è¡Œï¼‰ã€‚å†è¨­å®šã—ã¾ã™ã€‚`);
                        
                        // æ”¹è¡Œã‚’ä¿æŒã—ã¦å†è¨­å®š
                        const safeMessage = originalText
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#039;')
                            .replace(/\n/g, '<br>');
                        
                        // ä¸€åº¦ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰å†è¨­å®š
                        addedContent.innerHTML = '';
                        setTimeout(() => {
                            addedContent.innerHTML = safeMessage;
                            console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å†è¨­å®šã—ã¾ã—ãŸï¼ˆè©¦è¡Œ ' + attempt + 'ï¼‰');
                            // å†ç¢ºèª
                            setTimeout(() => checkMessageDisplay(attempt + 1), 100);
                        }, 10);
                    } else if (displayedText.length >= originalText.length * 0.8) {
                        console.log('âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
                    } else {
                        console.error('âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ3å›è©¦è¡Œå¾Œã‚‚ä¸å®Œå…¨ï¼‰');
                    }
                } else {
                    console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            };
            
            // è¤‡æ•°å›ãƒã‚§ãƒƒã‚¯ï¼ˆå³åº§ã€100mså¾Œã€500mså¾Œï¼‰
            setTimeout(() => checkMessageDisplay(1), 0);
            setTimeout(() => checkMessageDisplay(2), 100);
            setTimeout(() => checkMessageDisplay(3), 500);
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã™ã§ã«ä¸‹ã®æ–¹ã‚’è¦‹ã¦ã„ã‚‹ã¨ãã ã‘æœ€ä¸‹éƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆä¸Šã¾ã§èª­ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
            setTimeout(() => {
                const el = scrollContainer;
                const wasNearBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 120;
                if (wasNearBottom) {
                    el.scrollTop = el.scrollHeight;
                }
            }, 50);
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®HTMLã‚’ç”Ÿæˆ
        function createDebugInfoHTML(debugInfo) {
            if (!debugInfo || !debugInfo.usedApi) return '';

            const apiName = debugInfo.usedApi;
            const apiEmojis = {
                'gemini': 'ğŸ¤–',
                'groq': 'âš¡',
                'openai': 'ğŸ§ ',
                'huggingface': 'ğŸ¤—',
                'ollama': 'ğŸ¤–'
            };

            const apiNames = {
                'gemini': 'Google Gemini',
                'groq': 'Groq',
                'openai': 'OpenAI',
                'huggingface': 'Hugging Face',
                'ollama': 'Ollama'
            };

            let details = [];

            if (apiName === 'gemini' && debugInfo.geminiEnabled !== undefined) {
                details.push(`Geminiæœ‰åŠ¹: ${debugInfo.geminiEnabled ? 'âœ…' : 'âŒ'}`);
                details.push(`APIã‚­ãƒ¼è¨­å®š: ${debugInfo.geminiApiKeySet ? 'âœ…' : 'âŒ'}`);
            }

            return `
                <div class="debug-info ${apiName}">
                    <div class="debug-info-title">
                        ${apiEmojis[apiName] || 'ğŸ¤–'} ä½¿ç”¨AI: <strong>${apiNames[apiName] || apiName}</strong>
                    </div>
                    ${details.length > 0 ? `<div class="debug-info-detail">${details.join(' | ')}</div>` : ''}
                </div>
            `;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        async function sendMessage() {
            console.log('sendMessageé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
            const chatInput = document.getElementById('chatInput');
            const userMessage = chatInput.value.trim();

            console.log('å…¥åŠ›ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', userMessage);

            if (!userMessage) {
                console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã®ãŸã‚é€ä¿¡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
                return;
            }

            console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºä¸­...');
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addMessageToChat('user', userMessage);
            chatInput.value = '';

            // é€ä¿¡ä¸­ã¯å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const sendBtn = document.getElementById('sendBtn');
            chatInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.textContent = 'é€ä¿¡ä¸­...';

            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
            chatHistory.push({ sender: 'user', message: userMessage });

            // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
            const chatMessagesInner = document.getElementById('chatMessagesInner');
            const chatMessages = document.getElementById('chatMessages');
            const appendTo = chatMessagesInner || chatMessages;
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant-message';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="avatar assistant-message-avatar" style="background-image: url('images/olive.jpg'); background-size: cover; background-position: center; position: relative;"></div>
                <div class="content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            appendTo.appendChild(typingDiv);
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // AIã®å¿œç­”ã‚’ç”Ÿæˆï¼ˆPHP APIçµŒç”±ï¼‰
            try {
                console.log('PHP APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ä¸­...');

                // APIã¯å¸¸ã«åˆ©ç”¨ï¼ˆè¨­å®šæ¬„ã¯å»ƒæ­¢ï¼‰
                const useOllama = true;

                // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’APIå½¢å¼ã«å¤‰æ›ï¼ˆç›´è¿‘6ã‚¿ãƒ¼ãƒ³ã¾ã§ï¼‰
                const historyForAPI = chatHistory.slice(-6).map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'assistant',
                    content: msg.message
                }));

                const response = await fetch('api/ai-response.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        history: historyForAPI,
                        useOllama: useOllama
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('PHP API HTTPã‚¨ãƒ©ãƒ¼:', response.status, response.statusText);
                    console.error('ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', errorText);
                    throw new Error(`PHP API Error: ${response.status} ${response.statusText}\nãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${errorText.substring(0, 500)}`);
                }

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã—ã¦ã‹ã‚‰JSONè§£æ
                const responseText = await response.text();
                console.log('PHP APIã‹ã‚‰ã®ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:', responseText.substring(0, 500));

                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('PHP APIã‹ã‚‰ã®å¿œç­”ï¼ˆè§£ææˆåŠŸï¼‰:', data);
                } catch (jsonError) {
                    console.error('=== JSONè§£æã‚¨ãƒ©ãƒ¼ ===');
                    console.error('ã‚¨ãƒ©ãƒ¼:', jsonError);
                    console.error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå…¨æ–‡ï¼‰:', responseText);
                    console.error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹é•·:', responseText.length);
                    throw new Error(`JSONè§£æã‚¨ãƒ©ãƒ¼: ${jsonError.message}\nãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæœ€åˆã®1000æ–‡å­—ï¼‰: ${responseText.substring(0, 1000)}`);
                }

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼‰
                const usedApi = data.usedApi || data.apiType || 'unknown';
                const apiEmojis = {
                    'gemini': 'ğŸ¤–',
                    'groq': 'âš¡',
                    'openai': 'ğŸ§ ',
                    'huggingface': 'ğŸ¤—',
                    'ollama': 'ğŸ¤–'
                };
                const apiNames = {
                    'gemini': 'Google Gemini',
                    'groq': 'Groq',
                    'openai': 'OpenAI',
                    'huggingface': 'Hugging Face',
                    'ollama': 'Ollama'
                };

                console.log('%c=== AI API ä½¿ç”¨çŠ¶æ³ ===', 'font-size: 16px; font-weight: bold; color: #667eea;');
                console.log(`%c${apiEmojis[usedApi] || 'ğŸ¤–'} ä½¿ç”¨ã•ã‚ŒãŸAI: ${apiNames[usedApi] || usedApi}`,
                    'font-size: 14px; font-weight: bold; color: #4285f4; background: #e8f0fe; padding: 4px 8px; border-radius: 4px;');
                console.log('Geminiæœ‰åŠ¹:', data.debug?.geminiEnabled ? 'âœ…' : 'âŒ');
                console.log('Gemini APIã‚­ãƒ¼è¨­å®š:', data.debug?.geminiApiKeySet ? 'âœ…' : 'âŒ');
                console.log('OpenAIæœ‰åŠ¹:', data.debug?.openaiEnabled ? 'âœ…' : 'âŒ');
                console.log('OpenAI APIã‚­ãƒ¼è¨­å®š:', data.debug?.openaiApiKeySet ? 'âœ…' : 'âŒ');

                // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆé–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ç¢ºèªå¯èƒ½ï¼‰
                if (data.debug?.debugLogs && data.debug.debugLogs.length > 0) {
                    console.log('%c=== ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ï¼‰ ===', 'font-size: 14px; font-weight: bold; color: #ff6b6b;');
                    data.debug.debugLogs.forEach((log, index) => {
                        const isError = log.includes('ã‚¨ãƒ©ãƒ¼') || log.includes('å¤±æ•—') || log.includes('HTTP ã‚¨ãƒ©ãƒ¼');
                        const isSuccess = log.includes('æˆåŠŸ');
                        const style = isError
                            ? 'color: #ff6b6b; font-weight: bold;'
                            : isSuccess
                                ? 'color: #51cf66; font-weight: bold;'
                                : 'color: #495057;';
                        console.log(`%c[${index + 1}] ${log}`, style);
                    });
                    console.log('========================');
                }

                if (data.debug) {
                    console.log('è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ±:', data.debug);
                }
                console.log('========================');

                if (data && data.response) {
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ã‚’è¡¨ç¤º
                    let responseText = data.response;

                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒã‚ã‚‹å ´åˆã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è©³ç´°ã‚’è¡¨ç¤º
                    if (data.debug && !data.ollamaUsed && usedApi === 'unknown') {
                        console.warn('âš ï¸ AI APIãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                        console.warn('ãƒ‡ãƒãƒƒã‚°æƒ…å ±:', data.debug);

                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                        if (!data.ollamaAvailable) {
                            responseText += '\n\nğŸ’¡ ãƒ’ãƒ³ãƒˆ: AI APIãŒåˆ©ç”¨ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                        }
                    }

                    // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
                    const typingIndicator = document.getElementById('typing-indicator');
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }

                    // AIã®å¿œç­”ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å«ã‚€ï¼‰
                    addMessageToChat('assistant', responseText, data.debug || { usedApi: usedApi });
                    chatHistory.push({ sender: 'assistant', message: data.response });

                    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å†æœ‰åŠ¹åŒ–
                    chatInput.disabled = false;
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'é€ä¿¡';
                    chatInput.focus();
                } else {
                    throw new Error('PHP APIã‹ã‚‰ã®å¿œç­”ãŒç„¡åŠ¹ã§ã™');
                }

            } catch (error) {
                console.error('PHP APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
                console.log('ã‚¨ãƒ©ãƒ¼ã®è©³ç´°:', error.message);

                // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }

                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const errorMessage = `âŒ ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\n${error.message}\n\nã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`;

                addMessageToChat('assistant', errorMessage);
                chatHistory.push({ sender: 'assistant', message: errorMessage });

                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å†æœ‰åŠ¹åŒ–
                chatInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'é€ä¿¡';
                chatInput.focus();
            }
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿œç­”é–¢æ•°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ
        // AIãŒå®Ÿéš›ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿œç­”ã¯ä½¿ç”¨ã—ã¾ã›ã‚“
    </script>
</body>

</html>