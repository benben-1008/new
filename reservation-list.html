<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã€ç®¡ç†ç”¨ã€‘äºˆç´„ç¢ºèªä¸€è¦§ï¼ˆèªè¨¼ï¼‰</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 10px 0 20px 0;
    }

    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin: 10px 0 10px 0;
    }

    .filters label {
      font-weight: bold;
      color: #333;
      font-size: 14px;
    }

    .filters input,
    .filters select {
      padding: 10px 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      min-width: 180px;
    }

    .btn {
      padding: 12px 18px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background-color: #007bff;
      color: #fff;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: #fff;
    }

    .btn-secondary:hover {
      background-color: #545b62;
    }

    .btn-success {
      background-color: #28a745;
      color: #fff;
    }

    .btn-success:hover {
      background-color: #1f7f35;
    }

    .btn-disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>ğŸ§¾ ã€ç®¡ç†ç”¨ã€‘äºˆç´„ç¢ºèªä¸€è¦§ï¼ˆèªè¨¼ï¼‰</h1>
      <p>é£Ÿå ‚ã‚¹ã‚¿ãƒƒãƒ•å‘ã‘ï¼šäºˆç´„ã®ä¸€è¦§ç¢ºèªã¨ã€Œèªè¨¼ï¼ˆå—ã‘å–ã‚Šæ¸ˆã¿ï¼‰ã€ã®æ›´æ–°ãŒã§ãã¾ã™</p>
    </header>

    <main>
      <section class="card">
        <div class="actions">
          <button class="btn btn-primary" onclick="loadReservations()">äºˆç´„ä¸€è¦§ã‚’æ›´æ–°</button>
          <a class="btn btn-secondary" href="verification.html">â† äºˆç´„ç¢ºèªã«æˆ»ã‚‹</a>
          <a class="btn btn-secondary" href="admin.html">â† ç®¡ç†ç”»é¢ã«æˆ»ã‚‹</a>
        </div>
        <div class="filters">
          <div>
            <label for="filter-date">æ—¥ä»˜</label><br />
            <input id="filter-date" type="date" />
          </div>
          <div>
            <label for="filter-status">è¡¨ç¤º</label><br />
            <select id="filter-status">
              <option value="today">ä»Šæ—¥ã®äºˆç´„ã®ã¿</option>
              <option value="all">ã™ã¹ã¦</option>
              <option value="unverified">æœªèªè¨¼ã®ã¿</option>
              <option value="verified">èªè¨¼æ¸ˆã¿ã®ã¿</option>
            </select>
          </div>
          <div>
            <label for="filter-q">æ¤œç´¢ï¼ˆåå‰/ã‚¯ãƒ©ã‚¹/ç•ªå·/ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰</label><br />
            <input id="filter-q" type="text" placeholder="ä¾‹: ç”°ä¸­ / 2A / 123 / ã‚«ãƒ¬ãƒ¼" />
          </div>
        </div>
        <div id="reservations-list"></div>
        <p style="margin-top: 10px; color: #666; font-size: 14px;">
          â€» ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ã„ã¦ã„ã‚‹ï¼ˆURLãŒ <code>file://</code> ã§å§‹ã¾ã‚‹ï¼‰å ´åˆã€PHP(API)ãŒå‹•ã‹ãšä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã™ã€‚Webã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é–‹ã„ã¦ãã ã•ã„ã€‚
        </p>
      </section>

      <section>
        <h2>ğŸ”— URLãƒªãƒ³ã‚¯</h2>
        <div id="page-links" class="card"></div>
      </section>
    </main>

    <footer>
      <a href="index.html" class="back-link">â† ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
    </footer>
  </div>

  <script>
    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã® api/ ã‚’å‚ç…§ï¼ˆã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã§é–‹ã„ã¦ã‚‚æ­£ã—ãå‹•ä½œï¼‰
    function getApiBaseCandidates() {
      if (typeof window === 'undefined' || !window.location) return ['api/'];
      if (window.location.protocol === 'file:') return ['api/'];
      const sameDir = new URL('api/', window.location.href).toString();
      const parentDir = new URL('../api/', window.location.href).toString();
      const rootDir = window.location.origin + '/api/';
      const candidates = [sameDir, parentDir, rootDir].filter(u => {
        try { return new URL(u).origin === window.location.origin; } catch (_) { return false; }
      });
      return [...new Set(candidates)];
    }

    async function apiGet(path) {
      const candidates = getApiBaseCandidates();
      let lastErr = null;
      for (const base of candidates) {
        try {
          const res = await fetch(base + path, { cache: 'no-store' });
          if (!res.ok) { lastErr = new Error(`GET failed: ${base}${path} (HTTP ${res.status})`); continue; }
          const text = await res.text();
          try { return JSON.parse(text); } catch (e) { lastErr = e; continue; }
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error('GET failed');
    }

    async function apiPost(path, data) {
      const candidates = getApiBaseCandidates();
      let lastErr = null;
      for (const base of candidates) {
        try {
          const res = await fetch(base + path, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (!res.ok) { lastErr = new Error(`POST failed: ${base}${path} (HTTP ${res.status})`); continue; }
          return await res.json();
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error('POST failed');
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getTodayIso() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    async function markReservationAsVerified(name, number) {
      return await apiPost('sales-data.php', {
        action: 'verify',
        name: String(name || '').trim(),
        reservationNumber: parseInt(number, 10)
      });
    }

    // === äºˆç´„ä¸€è¦§ ===
    async function loadReservations() {
      const list = document.getElementById("reservations-list");
      let reservations = [];
      const isFileProtocol = window.location.protocol === 'file:';
      list.innerHTML = "<p style='color:#666;'>èª­ã¿è¾¼ã¿ä¸­...</p>";
      try {
        const raw = await fetch(apiBase + 'sales-data.php?reservations=true', { cache: 'no-store' }).then(r => r.json());
        if (Array.isArray(raw)) {
          reservations = raw;
        } else if (raw && Array.isArray(raw.reservations)) {
          reservations = raw.reservations;
        } else {
          reservations = [];
        }
      } catch (e) {
        console.error('äºˆç´„ä¸€è¦§ã®å–å¾—ã«å¤±æ•—:', e);
        let errMsg = 'äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        if (isFileProtocol) {
          errMsg += '<br><strong>â€» ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ã„ã¦ã„ã¾ã™ã€‚</strong> äºˆç´„ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€PHPãŒå‹•ä½œã™ã‚‹Webã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é–‹ã„ã¦ãã ã•ã„ã€‚';
        } else {
          errMsg += ' ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã€Œäºˆç´„ä¸€è¦§ã‚’æ›´æ–°ã€ã‚’æŠ¼ã™ã‹ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
        }
        list.innerHTML = "<p style='color:#dc3545;'>" + errMsg + "</p>";
        return;
      }

      if (reservations.length === 0) {
        let emptyMsg = 'äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆ0ä»¶ï¼‰ã€‚';
        emptyMsg += '<br>äºˆç´„ãŒå…¥ã£ãŸå¾Œã«ã€Œäºˆç´„ä¸€è¦§ã‚’æ›´æ–°ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        if (isFileProtocol) {
          emptyMsg += '<br><span style="color:#856404;"><strong>â€» ãƒ•ã‚¡ã‚¤ãƒ«ã§ç›´æ¥é–‹ã„ã¦ã„ã‚‹ã¨äºˆç´„ã¯ä¿å­˜ãƒ»è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</strong> Webã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é–‹ã„ã¦ãã ã•ã„ã€‚</span>';
        }
        list.innerHTML = "<p style='color:#666;'>" + emptyMsg + "</p>";
        return;
      }

      const filterDateEl = document.getElementById('filter-date');
      const filterStatusEl = document.getElementById('filter-status');
      const filterQEl = document.getElementById('filter-q');
      const selectedDate = (filterDateEl && filterDateEl.value) ? filterDateEl.value : getTodayIso();
      const mode = filterStatusEl ? filterStatusEl.value : 'today';
      const q = filterQEl ? String(filterQEl.value || '').trim().toLowerCase() : '';

      const isVerifiedFn = (r) => r.verified === true || r.verified === 'true' || r.verified === 1;

      // çµã‚Šè¾¼ã¿
      let filtered = reservations;
      if (mode === 'today') {
        filtered = filtered.filter(r => String(r.date || '') === selectedDate);
      } else if (mode === 'unverified') {
        filtered = filtered.filter(r => !isVerifiedFn(r));
      } else if (mode === 'verified') {
        filtered = filtered.filter(r => isVerifiedFn(r));
      } else if (mode === 'all') {
        // no-op
      }
      if (q) {
        filtered = filtered.filter(r => {
          const name = String(r.name || '').toLowerCase();
          const cls = String(r.studentClass || '').toLowerCase();
          const food = String(r.food || '').toLowerCase();
          const num = (r.reservationNumber != null ? String(r.reservationNumber) : '');
          return name.includes(q) || cls.includes(q) || food.includes(q) || num.includes(q);
        });
      }

      if (filtered.length === 0) {
        list.innerHTML = "<p style='color:#666;'>æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
      }

      // æ—¥ä»˜ãƒ»æ™‚é–“ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
      filtered = [...filtered].sort((a, b) => {
        const dateA = (a.date || '') + ' ' + (a.time || '');
        const dateB = (b.date || '') + ' ' + (b.time || '');
        return dateB.localeCompare(dateA);
      });

      // èªè¨¼ãƒœã‚¿ãƒ³ç”¨ã«ç¾åœ¨è¡¨ç¤ºä¸­ã®é…åˆ—ã‚’ä¿æŒ
      window.__visibleReservations = filtered;

      const tableRows = filtered.map((r, idx) => {
        const name = escapeHtml(String(r.name || '').trim() || 'â€”');
        const cls = escapeHtml(String(r.studentClass || '').trim() || 'â€”');
        const food = escapeHtml(String(r.food || '').trim() || 'â€”');
        const date = escapeHtml(String(r.date || 'â€”'));
        const time = escapeHtml(String(r.time || 'â€”'));
        const num = r.reservationNumber != null ? r.reservationNumber : 'â€”';
        const isVerified = isVerifiedFn(r);
        const verifiedMark = isVerified ? '<span style="color: #28a745;">âœ…</span>' : 'â€”';
        const actionBtn = isVerified
          ? `<button class="btn btn-secondary btn-disabled" disabled>èªè¨¼æ¸ˆã¿</button>`
          : `<button class="btn btn-success" onclick="handleVerifyClick(${idx})">èªè¨¼ï¼ˆå—ã‘å–ã‚Šï¼‰</button>`;
        return `
          <tr style="background-color: ${isVerified ? '#f0fff0' : '#fff'};">
            <td style="border: 1px solid #ddd; padding: 10px;">${date}</td>
            <td style="border: 1px solid #ddd; padding: 10px;">${time}</td>
            <td style="border: 1px solid #ddd; padding: 10px; font-weight: bold;">${name}</td>
            <td style="border: 1px solid #ddd; padding: 10px;">${cls}</td>
            <td style="border: 1px solid #ddd; padding: 10px;">${food}</td>
            <td style="border: 1px solid #ddd; padding: 10px;">${num}</td>
            <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${verifiedMark}</td>
            <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${actionBtn}</td>
          </tr>
        `;
      }).join('');

      list.innerHTML = `
        <div style="margin-bottom: 20px;">
          <h3 style="margin: 0 0 10px 0; color: #333;">ğŸ“‹ äºˆç´„ä¸€è¦§ï¼ˆèªè¨¼/å—ã‘å–ã‚Šç®¡ç†ï¼‰</h3>
          <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">
            è¡¨ç¤ºä»¶æ•°: <strong>${filtered.length}</strong> ä»¶
          </p>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
              <thead>
                <tr style="background-color: #f8f9fa;">
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">æ—¥ä»˜</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">æ™‚é–“</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">äºˆç´„è€…å</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">ã‚¯ãƒ©ã‚¹</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">äºˆç´„ãƒ¡ãƒ‹ãƒ¥ãƒ¼</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">äºˆç´„ç•ªå·</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">èªè¨¼</th>
                  <th style="border: 1px solid #ddd; padding: 10px; text-align: center;">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>${tableRows}</tbody>
            </table>
          </div>
        </div>
      `;
    }

    async function handleVerifyClick(index) {
      try {
        const items = Array.isArray(window.__visibleReservations) ? window.__visibleReservations : [];
        const r = items[index];
        if (!r) return;
        const name = String(r.name || '').trim();
        const num = r.reservationNumber;
        if (!name || num == null) {
          alert('èªè¨¼ã«å¿…è¦ãªæƒ…å ±ï¼ˆåå‰/äºˆç´„ç•ªå·ï¼‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚');
          return;
        }
        const ok = confirm(`ã€Œ${name}ã€ï¼ˆäºˆç´„ç•ªå·: ${num}ï¼‰ã‚’èªè¨¼ï¼ˆå—ã‘å–ã‚Šæ¸ˆã¿ï¼‰ã«ã—ã¾ã™ã‹ï¼Ÿ`);
        if (!ok) return;

        await markReservationAsVerified(name, num);
        await loadReservations();
      } catch (e) {
        console.error('èªè¨¼æ›´æ–°ã«å¤±æ•—:', e);
        alert('èªè¨¼ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼çŠ¶æ³ã‚’ç¢ºèªã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    }

    // ãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ã®è¡¨ç¤º
    function renderLinks() {
      const base = window.location.href.replace(/[^/]*$/, '');
      const pages = [
        { name: 'ç”Ÿå¾’ç”¨ã‚µã‚¤ãƒˆ (index.html)', file: 'index.html' },
        { name: 'äºˆç´„ç¢ºèªã‚·ã‚¹ãƒ†ãƒ  (verification.html)', file: 'verification.html' },
        { name: 'ç®¡ç†è€…ã‚µã‚¤ãƒˆ (admin.html)', file: 'admin.html' },
        { name: 'é£Ÿå ‚å°‚ç”¨AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ (ai-assistant-php.html)', file: 'ai-assistant-php.html' }
      ];
      const linksDiv = document.getElementById('page-links');
      if (!linksDiv) return;
      linksDiv.innerHTML = pages.map(p => {
        const url = base + p.file;
        return `<p><strong>${p.name}:</strong> <a href="${url}">${url}</a></p>`;
      }).join('');
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderLinks();
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸåŒ–ï¼ˆä»Šæ—¥ï¼‰
      const dateEl = document.getElementById('filter-date');
      if (dateEl) dateEl.value = getTodayIso();
      const statusEl = document.getElementById('filter-status');
      const qEl = document.getElementById('filter-q');
      const reload = () => loadReservations();
      if (dateEl) dateEl.addEventListener('change', reload);
      if (statusEl) statusEl.addEventListener('change', reload);
      if (qEl) qEl.addEventListener('input', reload);

      loadReservations();
      // 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°ï¼ˆå¿…è¦ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆå¯èƒ½ï¼‰
      setInterval(loadReservations, 30000);
    });
  </script>
</body>

</html>

