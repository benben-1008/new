<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äºˆç´„ã‚·ã‚¹ãƒ†ãƒ  - OliMeal</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .page-bg {
      background-image: url('images/olive.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    .container {
      background-color: rgba(255, 255, 255, 0.95);
    }

    /* äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .booking-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .booking-header {
      text-align: center;
      padding: 30px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px 15px 0 0;
      margin-bottom: 0;
    }

    .booking-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: white;
    }

    .booking-header p {
      font-size: 1.1rem;
      opacity: 0.95;
    }

    .booking-card {
      background: white;
      border-radius: 0 0 15px 15px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 1rem;
    }

    .form-group label .required {
      color: #dc3545;
      margin-left: 4px;
    }

    .form-group input[type="text"],
    .form-group select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #fafafa;
    }

    .form-group input[type="text"]:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group small {
      display: block;
      margin-top: 6px;
      color: #666;
      font-size: 0.875rem;
    }

    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 35px;
    }

    .btn-submit {
      flex: 2;
      padding: 16px 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-submit:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-reset {
      flex: 1;
      padding: 16px 32px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-reset:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    /* çµæœè¡¨ç¤º */
    .result-box {
      display: none;
      margin-top: 25px;
      padding: 25px;
      border-radius: 10px;
      animation: slideIn 0.4s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result-success {
      background: #d4edda;
      border: 2px solid #c3e6cb;
      color: #155724;
    }

    .result-error {
      background: #f8d7da;
      border: 2px solid #f5c6cb;
      color: #721c24;
    }

    .result-box h3 {
      margin: 0 0 15px 0;
      font-size: 1.3rem;
    }

    .result-box p {
      margin: 8px 0;
      line-height: 1.6;
    }

    .reservation-number {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
      margin: 10px 0;
    }

    .result-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º */
    .menu-preview {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
    }

    .menu-preview h3 {
      margin-top: 0;
      color: #667eea;
    }

    .menu-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .menu-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      text-align: center;
    }

    .menu-item-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .menu-item-stock {
      font-size: 0.875rem;
      color: #666;
    }

    .menu-item-stock.unlimited {
      color: #28a745;
      font-weight: 600;
    }

    .menu-item-stock.soldout {
      color: #dc3545;
      font-weight: 600;
    }

    /* äºˆç´„çŠ¶æ³ */
    .status-preview {
      background: #e3f2fd;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
    }

    .status-preview h3 {
      margin-top: 0;
      color: #1976d2;
    }

    .status-item {
      background: white;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .booking-card {
        padding: 25px 20px;
      }

      .booking-header h1 {
        font-size: 2rem;
      }

      .form-actions {
        flex-direction: column;
      }

      .btn-submit,
      .btn-reset {
        width: 100%;
      }

      .menu-list {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body class="page-bg">
  <div class="container">
    <div class="booking-container">
      <div class="booking-header">
        <h1>ğŸ½ï¸ äºˆç´„ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>ç°¡å˜3ã‚¹ãƒ†ãƒƒãƒ—ã§äºˆç´„å®Œäº†ï¼</p>
      </div>

      <div class="booking-card">
        <form id="booking-form">
          <div class="form-group">
            <label for="student-name">
              ãŠåå‰ <span class="required">*</span>
            </label>
            <input type="text" id="student-name" required placeholder="ä¾‹: ç”°ä¸­å¤ªéƒ" autocomplete="name">
          </div>

          <div class="form-group">
            <label for="food">
              ã”å¸Œæœ›ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ <span class="required">*</span>
            </label>
            <select id="food" required>
              <option value="">-- èª­ã¿è¾¼ã¿ä¸­... --</option>
            </select>
            <small>â€» åœ¨åº«ãŒãªã„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯é¸æŠã§ãã¾ã›ã‚“</small>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-submit" id="submit-btn">
              ğŸ“ äºˆç´„ã‚’ç¢ºå®š
            </button>
            <button type="button" class="btn-reset" onclick="resetForm()">
              ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>
        </form>

        <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="result-box" class="result-box"></div>

        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ -->
        <div class="menu-preview">
          <h3>ğŸ“‹ ç¾åœ¨ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§</h3>
          <div id="menu-display" class="loading">
            <div class="spinner"></div>
            <p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>

        <!-- ä»Šæ—¥ã®äºˆç´„çŠ¶æ³ -->
        <div class="status-preview">
          <h3>ğŸ“Š ä»Šæ—¥ã®äºˆç´„çŠ¶æ³</h3>
          <div id="reservations-display" class="loading">
            <div class="spinner"></div>
            <p>äºˆç´„çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </div>
      </div>
    </div>

    <footer style="text-align: center; padding: 30px 20px;">
      <a href="index.html" class="back-link" style="font-size: 1.1rem;">â† ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
    </footer>
  </div>

  <script>
    // APIãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ã®è§£æ±º
    function getApiBase() {
      if (typeof window === 'undefined' || !window.location) return 'api/';
      if (window.location.protocol === 'file:') return 'api/';
      const path = window.location.pathname;
      const lastSlash = path.lastIndexOf('/');
      const basePath = lastSlash >= 0 ? path.substring(0, lastSlash + 1) : '/';
      return basePath + 'api/';
    }

    let __apiBaseResolved = null;

    async function resolveApiBase() {
      if (__apiBaseResolved) return __apiBaseResolved;

      // å€™è£œãƒ‘ã‚¹ã®ç”Ÿæˆ
      const candidates = [];
      try {
        candidates.push(new URL('api/', window.location.href).toString());
      } catch (_) { }
      try {
        candidates.push(new URL('../api/', window.location.href).toString());
      } catch (_) { }
      try {
        candidates.push(window.location.origin + '/api/');
      } catch (_) { }

      // åŒä¸€ã‚ªãƒªã‚¸ãƒ³ã®å€™è£œã ã‘ã«ã™ã‚‹
      const validCandidates = candidates.filter(u => {
        try {
          return new URL(u).origin === window.location.origin;
        } catch (_) {
          return false;
        }
      });

      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] APIãƒ™ãƒ¼ã‚¹å€™è£œ:', validCandidates);

      const probePath = 'menu.php';
      for (const base of validCandidates) {
        try {
          console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ãƒ—ãƒ­ãƒ¼ãƒ–ä¸­:', base + probePath);
          const res = await fetch(base + probePath, {
            cache: 'no-store',
            method: 'GET'
          });
          if (res.ok) {
            __apiBaseResolved = base;
            console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] âœ… APIãƒ™ãƒ¼ã‚¹ã‚’ç¢ºå®š:', __apiBaseResolved);
            return __apiBaseResolved;
          } else {
            console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ãƒ—ãƒ­ãƒ¼ãƒ–å¤±æ•—:', base + probePath, res.status);
          }
        } catch (e) {
          console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ãƒ—ãƒ­ãƒ¼ãƒ–ã‚¨ãƒ©ãƒ¼:', base + probePath, e);
          continue;
        }
      }
      __apiBaseResolved = getApiBase();
      console.warn('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] âš ï¸ APIãƒ™ãƒ¼ã‚¹ç¢ºå®šã«å¤±æ•—ã€‚å¾“æ¥ãƒ‘ã‚¹ã‚’ä½¿ç”¨:', __apiBaseResolved);
      return __apiBaseResolved;
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
    function getTodayIso() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨äºˆç´„çŠ¶æ³ã‚’èª­ã¿è¾¼ã‚€
    async function loadMenuAndStatus() {
      const foodSelect = document.getElementById('food');
      const menuDisplay = document.getElementById('menu-display');
      const reservationsDisplay = document.getElementById('reservations-display');

      try {
        const apiBase = await resolveApiBase();
        const [menuRes, resRes] = await Promise.all([
          fetch(apiBase + 'menu.php', { cache: 'no-store' }),
          fetch(apiBase + 'sales-data.php?reservations=true', { cache: 'no-store' })
        ]);

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿
        if (menuRes.ok) {
          const menus = await menuRes.json().catch(() => []);
          if (Array.isArray(menus) && menus.length > 0) {
            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            if (foodSelect) {
              foodSelect.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>' +
                menus.map(m => {
                  const label = m.stock === -1
                    ? `${m.name}ï¼ˆç„¡åˆ¶é™ï¼‰`
                    : `${m.name}ï¼ˆæ®‹ã‚Š${m.stock}é£Ÿï¼‰`;
                  const disabled = (m.stock !== -1 && m.stock <= 0) ? ' disabled' : '';
                  return `<option value="${escapeHtml(m.name)}"${disabled}>${escapeHtml(label)}</option>`;
                }).join('');
            }

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
            if (menuDisplay) {
              menuDisplay.innerHTML = '<div class="menu-list">' +
                menus.map(m => {
                  let stockClass = '';
                  let stockText = '';
                  if (m.stock === -1) {
                    stockClass = 'unlimited';
                    stockText = 'ç„¡åˆ¶é™';
                  } else if (m.stock <= 0) {
                    stockClass = 'soldout';
                    stockText = 'å£²ã‚Šåˆ‡ã‚Œ';
                  } else {
                    stockText = `æ®‹ã‚Š${m.stock}é£Ÿ`;
                  }
                  return `
                    <div class="menu-item">
                      <div class="menu-item-name">${escapeHtml(m.name)}</div>
                      <div class="menu-item-stock ${stockClass}">${stockText}</div>
                    </div>
                  `;
                }).join('') + '</div>';
            }
          } else {
            if (foodSelect) foodSelect.innerHTML = '<option value="">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</option>';
            if (menuDisplay) menuDisplay.innerHTML = '<p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†ç”»é¢ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
          }
        } else {
          if (foodSelect) foodSelect.innerHTML = '<option value="">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</option>';
          if (menuDisplay) menuDisplay.innerHTML = '<p style="color: #dc3545;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
        }

        // äºˆç´„çŠ¶æ³ã®èª­ã¿è¾¼ã¿
        if (resRes.ok) {
          const raw = await resRes.json();
          const list = Array.isArray(raw) ? raw : (raw?.reservations || []);
          const today = getTodayIso();
          const byFood = {};

          list
            .filter(r => String(r.date || '') === today)
            .forEach(r => {
              const f = (r.food && String(r.food).trim()) || 'ï¼ˆæœªè¨­å®šï¼‰';
              if (!byFood[f]) byFood[f] = 0;
              byFood[f] += (r.people || 1);
            });

          const entries = Object.entries(byFood);
          if (reservationsDisplay) {
            if (entries.length === 0) {
              reservationsDisplay.innerHTML = '<p>ä»Šæ—¥ã®äºˆç´„ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            } else {
              reservationsDisplay.innerHTML = entries.map(([food, n]) =>
                `<div class="status-item">
                  <span><strong>${escapeHtml(food)}</strong></span>
                  <span>${n}äºº</span>
                </div>`
              ).join('');
            }
          }
        } else {
          if (reservationsDisplay) {
            reservationsDisplay.innerHTML = '<p style="color: #dc3545;">äºˆç´„çŠ¶æ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
          }
        }
      } catch (e) {
        console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        if (foodSelect) foodSelect.innerHTML = '<option value="">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</option>';
        if (menuDisplay) menuDisplay.innerHTML = '<p style="color: #dc3545;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Webã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é–‹ã„ã¦ãã ã•ã„ã€‚</p>';
        if (reservationsDisplay) reservationsDisplay.innerHTML = '<p style="color: #dc3545;">äºˆç´„çŠ¶æ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
      }
    }

    // çµæœã‚’è¡¨ç¤º
    function showResult(success, html) {
      const resultBox = document.getElementById('result-box');
      if (!resultBox) return;

      resultBox.className = `result-box ${success ? 'result-success' : 'result-error'}`;
      resultBox.innerHTML = html;
      resultBox.style.display = 'block';
      resultBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // çµæœã‚’éè¡¨ç¤º
    function hideResult() {
      const resultBox = document.getElementById('result-box');
      if (resultBox) {
        resultBox.style.display = 'none';
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    function resetForm() {
      document.getElementById('booking-form').reset();
      hideResult();
    }

    // äºˆç´„ã‚’é€ä¿¡
    async function submitReservation(formData) {
      const apiBase = await resolveApiBase();
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] APIãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹:', apiBase);
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿:', formData);

      // 1. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦æ®‹æ•°ã‚’ãƒã‚§ãƒƒã‚¯
      const menuUrl = apiBase + 'menu.php';
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾—URL:', menuUrl);
      const menuResponse = await fetch(menuUrl, { cache: 'no-store' });
      if (!menuResponse.ok) {
        const errorText = await menuResponse.text().catch(() => '');
        console.error('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', menuResponse.status, errorText);
        throw new Error(`ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP ${menuResponse.status}ï¼‰`);
      }

      const menus = await menuResponse.json();
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] å–å¾—ã—ãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼:', menus);
      const selectedMenu = menus.find(menu => menu.name === formData.food);
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] é¸æŠã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼:', selectedMenu);

      if (!selectedMenu) {
        throw new Error('é¸æŠã•ã‚ŒãŸãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }

      // æ®‹æ•°ãƒã‚§ãƒƒã‚¯
      if (selectedMenu.stock !== -1 && selectedMenu.stock <= 0) {
        throw new Error('ã“ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯å£²ã‚Šåˆ‡ã‚Œã§ã™');
      }

      // æ®‹æ•°ã‚’æ¸›ã‚‰ã™ï¼ˆç„¡åˆ¶é™ã§ãªã„å ´åˆï¼‰
      if (selectedMenu.stock !== -1) {
        selectedMenu.stock -= 1;
        const updateResponse = await fetch(apiBase + 'menu.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(menus)
        });

        if (!updateResponse.ok) {
          const errorText = await updateResponse.text().catch(() => '');
          console.error('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', updateResponse.status, errorText);
          throw new Error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ®‹æ•°æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ®‹æ•°ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      }

      // 2. äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      const reservation = {
        id: Date.now(),
        date: getTodayIso(),
        time: new Date().toTimeString().split(' ')[0].substring(0, 5),
        name: formData.name.trim(),
        studentClass: '', // å­¦å¹´ãƒ»ã‚¯ãƒ©ã‚¹ã¯ä¸è¦ãªã®ã§ç©ºæ–‡å­—
        people: 1,
        food: formData.food,
        reservationNumber: null
      };
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ä½œæˆã—ãŸäºˆç´„ãƒ‡ãƒ¼ã‚¿:', reservation);

      // 3. æ—¢å­˜ã®äºˆç´„ã‚’å–å¾—ï¼ˆsales-data.jsonã‹ã‚‰ï¼‰
      const reservationsUrl = apiBase + 'sales-data.php?reservations=true';
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] äºˆç´„å–å¾—URL:', reservationsUrl);
      const res = await fetch(reservationsUrl, { cache: 'no-store' });
      if (!res.ok) {
        const errorText = await res.text().catch(() => '');
        console.error('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] äºˆç´„å–å¾—ã‚¨ãƒ©ãƒ¼:', res.status, errorText);
        throw new Error(`äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP ${res.status}ï¼‰`);
      }

      const raw = await res.json();
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] å–å¾—ã—ãŸç”Ÿãƒ‡ãƒ¼ã‚¿:', raw);
      let existingReservations = [];
      if (Array.isArray(raw)) {
        existingReservations = raw;
      } else if (raw && Array.isArray(raw.reservations)) {
        existingReservations = raw.reservations;
      }
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] æ—¢å­˜äºˆç´„æ•°:', existingReservations.length);
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] æ—¢å­˜äºˆç´„ä¸€è¦§ï¼ˆæœ€åˆã®3ä»¶ï¼‰:', existingReservations.slice(0, 3));

      // 4. é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåå‰ã®ã¿ã§ãƒã‚§ãƒƒã‚¯ï¼‰
      const today = reservation.date;
      const reservationName = reservation.name.trim();
      const duplicateReservation = existingReservations.find(r => {
        const rDate = r.date || '';
        const rName = (r.name || '').trim();
        return rDate === today && rName === reservationName;
      });

      if (duplicateReservation) {
        throw new Error(`${today}ã«ã€Œ${reservationName}ã€ã•ã‚“ã¯æ—¢ã«äºˆç´„æ¸ˆã¿ã§ã™ã€‚åŒã˜æ—¥ã«è¤‡æ•°ã®äºˆç´„ã¯ã§ãã¾ã›ã‚“ã€‚`);
      }

      // 5. äºˆç´„ç•ªå·ã‚’æ¡ç•ªï¼ˆ1-999ï¼‰
      const usedNumbers = new Set(
        existingReservations
          .filter(r => String(r.date || '') === today)
          .map(r => parseInt(r.reservationNumber, 10))
          .filter(n => Number.isFinite(n) && n >= 1 && n <= 999)
      );

      let candidate = null;
      for (let i = 0; i < 2000; i++) {
        const n = Math.floor(Math.random() * 999) + 1;
        if (!usedNumbers.has(n)) {
          candidate = n;
          break;
        }
      }

      if (candidate === null) {
        for (let n = 1; n <= 999; n++) {
          if (!usedNumbers.has(n)) {
            candidate = n;
            break;
          }
        }
      }

      if (candidate === null) {
        throw new Error('æœ¬æ—¥ã®äºˆç´„ç•ªå·ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸï¼ˆ999ä»¶ï¼‰ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚');
      }

      reservation.reservationNumber = candidate;
      existingReservations.push(reservation);
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] äºˆç´„ç•ªå·ã‚’æ¡ç•ª:', candidate);
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ä¿å­˜å¾Œã®ç·äºˆç´„æ•°:', existingReservations.length);

      // 6. äºˆç´„ã‚’ä¿å­˜ï¼ˆsales-data.jsonã«ï¼‰
      const saveUrl = apiBase + 'sales-data.php';
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] äºˆç´„ä¿å­˜URL:', saveUrl);
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ä¿å­˜ã™ã‚‹æ–°ã—ã„äºˆç´„ãƒ‡ãƒ¼ã‚¿:', reservation);
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ä¿å­˜ã™ã‚‹å…¨äºˆç´„ãƒ‡ãƒ¼ã‚¿ï¼ˆæ—¢å­˜ + æ–°è¦ï¼‰:', existingReservations);
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ğŸ“¤ POSTé€ä¿¡ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONï¼‰:', JSON.stringify(existingReservations, null, 2));

      const saveResponse = await fetch(saveUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'save-all',
          reservations: existingReservations
        })
      });

      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ä¿å­˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', saveResponse.status, saveResponse.statusText);

      if (!saveResponse.ok) {
        const errorText = await saveResponse.text().catch(() => '');
        console.error('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆHTTPï¼‰:', saveResponse.status, errorText);
        let errorData = {};
        try {
          errorData = JSON.parse(errorText);
        } catch (e) {
          errorData = { error: errorText || `HTTP ${saveResponse.status}` };
        }
        console.error('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ã‚¨ãƒ©ãƒ¼ãƒ‡ãƒ¼ã‚¿:', errorData);
        const errorMessage = errorData.message || errorData.error || `äºˆç´„ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP ${saveResponse.status}ï¼‰`;
        throw new Error(errorMessage);
      }

      const saveResult = await saveResponse.json().catch((e) => {
        console.error('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] JSONè§£æã‚¨ãƒ©ãƒ¼:', e);
        return { ok: false, error: 'ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' };
      });

      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ä¿å­˜çµæœ:', saveResult);

      if (saveResult && saveResult.ok !== true) {
        throw new Error(saveResult.error || saveResult.message || 'äºˆç´„ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      // ä¿å­˜ç¢ºèªï¼šã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ã§ä¿å­˜å…ˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ä»¶æ•°ã‚’ç¢ºèª
      if (saveResult && saveResult.file) {
        console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ğŸ“ ä¿å­˜å…ˆãƒ•ã‚¡ã‚¤ãƒ«:', saveResult.file);
      }
      if (saveResult && saveResult.count !== undefined) {
        console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ğŸ“Š ä¿å­˜ã•ã‚ŒãŸäºˆç´„ä»¶æ•°:', saveResult.count);
      }

      // ä¿å­˜ç¢ºèªï¼šå†åº¦å–å¾—ã—ã¦ç¢ºèªï¼ˆsales-data.json ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸã‹ç¢ºèªï¼‰
      try {
        const verifyRes = await fetch(reservationsUrl, { cache: 'no-store' });
        if (verifyRes.ok) {
          const verifyData = await verifyRes.json();
          const verifyList = Array.isArray(verifyData) ? verifyData : (verifyData?.reservations || []);
          const found = verifyList.find(r => r.id === reservation.id ||
            (r.name === reservation.name && r.reservationNumber === reservation.reservationNumber && r.date === reservation.date));
          if (found) {
            console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] âœ… äºˆç´„ã®ä¿å­˜ãŒç¢ºèªã•ã‚Œã¾ã—ãŸï¼ˆsales-data.json ã‹ã‚‰èª­ã¿è¾¼ã¿æˆåŠŸï¼‰');
            console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ğŸ“‹ ä¿å­˜ã•ã‚ŒãŸäºˆç´„å†…å®¹:', found);
          } else {
            console.warn('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] âš ï¸ äºˆç´„ã®ä¿å­˜ç¢ºèªã«å¤±æ•—ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰');
            console.warn('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ç¾åœ¨ã®äºˆç´„ä¸€è¦§:', verifyList);
          }
        }
      } catch (e) {
        console.warn('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ä¿å­˜ç¢ºèªã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ï¼‰:', e);
      }

      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] âœ… äºˆç´„ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸ:', reservation);
      console.log('[äºˆç´„ãƒ‡ãƒãƒƒã‚°] ğŸ’¾ ã“ã®äºˆç´„ã¯ sales-data.json ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ');
      return reservation;
    }

    // äºˆç´„æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼
    async function copyReservationInfo(text) {
      try {
        if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
          await navigator.clipboard.writeText(String(text));
          alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        } else {
          prompt('ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„:', String(text));
        }
      } catch (e) {
        prompt('ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„:', String(text));
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    document.addEventListener('DOMContentLoaded', function () {
      console.log('[äºˆç´„] ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');

      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨äºˆç´„çŠ¶æ³ã‚’èª­ã¿è¾¼ã‚€
      loadMenuForPage();

      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
      const form = document.getElementById('booking-form');
      if (form) {
        form.addEventListener('submit', async function (e) {
          e.preventDefault();

          const formData = {
            name: document.getElementById('student-name').value.trim(),
            food: document.getElementById('food').value
          };

          // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
          if (!formData.name) {
            showResult(false, '<h3>âŒ ã‚¨ãƒ©ãƒ¼</h3><p>ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>');
            return;
          }

          if (!formData.food) {
            showResult(false, '<h3>âŒ ã‚¨ãƒ©ãƒ¼</h3><p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>');
            return;
          }

          // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
          const submitButton = document.getElementById('submit-btn');
          const originalText = submitButton.textContent;
          submitButton.disabled = true;
          submitButton.textContent = 'é€ä¿¡ä¸­...';

          hideResult();

          try {
            const reservation = await submitReservation(formData);
            const copyText = `${reservation.name} / äºˆç´„ç•ªå·: ${reservation.reservationNumber} / ${reservation.food} / ${reservation.date} ${reservation.time}`;

            showResult(true, `
              <h3>âœ… äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h3>
              <p><strong>äºˆç´„ç•ªå·:</strong></p>
              <div class="reservation-number">${escapeHtml(reservation.reservationNumber)}</div>
              <p><strong>ãŠåå‰:</strong> ${escapeHtml(reservation.name)}</p>
              <p><strong>ãƒ¡ãƒ‹ãƒ¥ãƒ¼:</strong> ${escapeHtml(reservation.food)}</p>
              <p><strong>æ—¥ä»˜:</strong> ${escapeHtml(reservation.date)} ${escapeHtml(reservation.time)}</p>
              <div class="result-actions">
                <button class="btn-submit" onclick="copyReservationInfo('${copyText.replace(/'/g, "\\'")}')" style="flex: 1;">
                  ğŸ“‹ äºˆç´„æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼
                </button>
                <a href="admin.html" class="btn-submit" style="flex: 1; text-decoration: none; text-align: center;">
                  ç®¡ç†ç”»é¢ã§ç¢ºèª
                </a>
              </div>
              <p style="margin-top: 15px; font-size: 0.9rem; color: #155724;">
                â€» ã“ã®äºˆç´„ç•ªå·ã¯å—ã‘å–ã‚Šç¢ºèªã«ä½¿ã„ã¾ã™ã€‚å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
              </p>
            `);

            // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            await loadMenuAndStatus();
          } catch (error) {
            console.error('[äºˆç´„] âŒ äºˆç´„ã®é€ä¿¡ã«å¤±æ•—:', error);
            console.error('[äºˆç´„] ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
              message: error.message,
              stack: error.stack,
              name: error.name
            });
            const errorMsg = error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
            let debugInfo = '';
            if (error.message && error.message.includes('HTTP')) {
              debugInfo = '<p style="margin-top: 10px; font-size: 0.9rem; color: #721c24;"><strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ã‚­ãƒ¼ï¼‰ã§ <code>[äºˆç´„ãƒ‡ãƒãƒƒã‚°]</code> ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
            }
            showResult(false, `
              <h3>âŒ äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
              <p style="font-weight: bold; font-size: 1.1rem;">${escapeHtml(errorMsg)}</p>
              ${debugInfo}
              <p style="margin-top: 15px; font-size: 0.9rem; color: #721c24;">
                ğŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ã‚­ãƒ¼ï¼‰ã§è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ç¢ºèªã§ãã¾ã™ã€‚<br>
                InfinityFreeç’°å¢ƒã®å ´åˆã€<code>data/</code> ãƒ•ã‚©ãƒ«ãƒ€ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>
                ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«ã¯ <code>[äºˆç´„ãƒ‡ãƒãƒƒã‚°]</code> ã¨ã„ã†ã‚¿ã‚°ãŒä»˜ã„ã¦ã„ã¾ã™ã€‚
              </p>
            `);
          } finally {
            submitButton.disabled = false;
            submitButton.textContent = originalText;
          }
        });
      }
    });

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨äºˆç´„çŠ¶æ³ã‚’èª­ã¿è¾¼ã‚€ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦ã‚‚ä½¿ç”¨å¯èƒ½ï¼‰
    async function loadMenuForPage() {
      await loadMenuAndStatus();
    }

    // èƒŒæ™¯ç”»åƒã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–
    document.addEventListener('DOMContentLoaded', function () {
      const pageBg = document.querySelector('.page-bg');
      if (pageBg) {
        const timestamp = new Date().getTime();
        pageBg.style.backgroundImage = `url('images/olive.jpg?v=${timestamp}')`;
      }
    });
  </script>
</body>

</html>